{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "e7375bc9",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "OK -> C:/Users/User/Desktop/球員資料/fangraphs_standard.csv，共 16 筆資料，23 欄。\n"
     ]
    }
   ],
   "source": [
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.common.keys import Keys\n",
    "from selenium.webdriver.chrome.service import Service\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "import csv, time\n",
    "\n",
    "url = \"https://www.fangraphs.com/players/jose-ramirez/13510/stats?position=OF\"\n",
    "\n",
    "# === 瀏覽器設定 ===\n",
    "options = Options()\n",
    "options.add_argument(\"--start-maximized\")\n",
    "options.add_argument(\"--disable-blink-features=AutomationControlled\")\n",
    "driver = webdriver.Chrome(options=options)\n",
    "\n",
    "try:\n",
    "    driver.get(url)\n",
    "\n",
    "    wait = WebDriverWait(driver, 20)\n",
    "\n",
    "    # 1) 確保在「Standard / MLB Regular Season」\n",
    "    #    若頁面有分頁按鈕，點一下 \"MLB Regular Season\"\n",
    "    try:\n",
    "        tab = wait.until(EC.element_to_be_clickable(\n",
    "            (By.XPATH, \"//button[normalize-space()='MLB Regular Season'] | //a[normalize-space()='MLB Regular Season']\")))\n",
    "        tab.click()\n",
    "        time.sleep(0.8)\n",
    "    except Exception:\n",
    "        pass  # 沒分頁就略過\n",
    "\n",
    "    # 2) 等 #standard 容器出現並滾到可視範圍\n",
    "    container = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"#standard.player-page-table\")))\n",
    "    driver.execute_script(\"arguments[0].scrollIntoView({block:'center'});\", container)\n",
    "    time.sleep(0.6)\n",
    "\n",
    "    rows = None\n",
    "\n",
    "    # 3A) 嘗試抓 <table>\n",
    "    try:\n",
    "        table = container.find_element(By.CSS_SELECTOR, \"table\")\n",
    "        tr_elems = table.find_elements(By.CSS_SELECTOR, \"tr\")\n",
    "        rows = []\n",
    "        for tr in tr_elems:\n",
    "            cells = tr.find_elements(By.CSS_SELECTOR, \"th,td\")\n",
    "            rows.append([c.text.strip() for c in cells])\n",
    "    except Exception:\n",
    "        rows = None\n",
    "\n",
    "    # 3B) 若沒有 <table>，用 text + \\t 解析\n",
    "    if not rows or len(rows) <= 1:\n",
    "        text = container.text  # 含 \\t 的表格文字\n",
    "        # 擷取含多個 tab 的行\n",
    "        lines = [ln for ln in text.splitlines() if ln.count(\"\\t\") >= 5]\n",
    "\n",
    "        # 找表頭行：包含常見欄名片段\n",
    "        header_idx = None\n",
    "        for i, ln in enumerate(lines):\n",
    "            if \"\\tG\\t\" in ln and \"\\tAB\\t\" in ln and \"\\tPA\\t\" in ln:\n",
    "                header_idx = i\n",
    "                break\n",
    "        if header_idx is None:\n",
    "            raise RuntimeError(\"找不到表頭行，請檢查頁面是否改版或被擋。\")\n",
    "\n",
    "        header = lines[header_idx].split(\"\\t\")\n",
    "        ncol = len(header)\n",
    "        data_lines = []\n",
    "        # 從表頭下一行開始，直到遇到下一個表頭或結尾\n",
    "        for ln in lines[header_idx+1:]:\n",
    "            # 若再次遇到表頭或切到其他區塊就停止\n",
    "            if ln.startswith(\"Season\\tTeam\\t\") and \"\\tG\\t\" in ln:\n",
    "                break\n",
    "            parts = ln.split(\"\\t\")\n",
    "            # 僅保留欄數吻合或可截斷的行\n",
    "            if len(parts) >= ncol:\n",
    "                data_lines.append(parts[:ncol])\n",
    "\n",
    "        rows = [header] + data_lines\n",
    "\n",
    "    # 4) 簡單清理：去除空列、全空字串列\n",
    "    cleaned = []\n",
    "    for r in rows:\n",
    "        if any(cell.strip() for cell in r):\n",
    "            cleaned.append(r)\n",
    "\n",
    "    # 5) 輸出 CSV\n",
    "    out_path = \"C:/Users/User/Desktop/球員資料/fangraphs_standard.csv\"\n",
    "    with open(out_path, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "        writer = csv.writer(f)\n",
    "        writer.writerows(cleaned)\n",
    "\n",
    "    print(f\"OK -> {out_path}，共 {len(cleaned)-1} 筆資料，{len(cleaned[0])} 欄。\")\n",
    "\n",
    "finally:\n",
    "    driver.quit()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "6d6eb6da",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "OK -> C:\\Users\\User\\Desktop\\leaders_name_hrefs.csv，共 1 筆 href\n"
     ]
    }
   ],
   "source": [
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "import csv, os\n",
    "\n",
    "url = (\"https://www.fangraphs.com/leaders/major-league?\"\n",
    "       \"pos=all&stats=bat&lg=all&qual=y&type=8&ind=0&rost=0&age=0&filter=&\"\n",
    "       \"players=0&pageitems=30&startdate=&enddate=&team=0&month=0&\"\n",
    "       \"season1=2020&season=2025&pagenum=1\")\n",
    "\n",
    "opts = Options()\n",
    "opts.add_argument(\"--start-maximized\")\n",
    "driver = webdriver.Chrome(options=opts)\n",
    "wait = WebDriverWait(driver, 20)\n",
    "\n",
    "try:\n",
    "    driver.get(url)\n",
    "\n",
    "    thead = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"table thead\")))\n",
    "    tbody = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"table tbody\")))\n",
    "\n",
    "    # 找 Name 欄位索引（兼容 #Name/Name）\n",
    "    headers = [th.text.strip() for th in thead.find_elements(By.CSS_SELECTOR, \"th\")]\n",
    "    name_idx = next((i for i, h in enumerate(headers) if h.lower().endswith(\"name\")), 1)\n",
    "\n",
    "    hrefs = []\n",
    "    for tr in tbody.find_elements(By.CSS_SELECTOR, \"tr\"):\n",
    "        tds = tr.find_elements(By.CSS_SELECTOR, \"td\")\n",
    "        if len(tds) > name_idx:\n",
    "            a = tds[name_idx].find_elements(By.CSS_SELECTOR, \"a\")\n",
    "            if a:\n",
    "                href = a[0].get_attribute(\"href\") or \"\"\n",
    "                if href:\n",
    "                    hrefs.append([href])   # 只存網址\n",
    "\n",
    "    out_csv = os.path.join(os.path.expanduser(\"~\"), \"Desktop\", \"leaders_name_hrefs.csv\")\n",
    "    with open(out_csv, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "        csv.writer(f).writerows(hrefs)\n",
    "\n",
    "    print(f\"OK -> {out_csv}，共 {len(hrefs)} 筆 href\")\n",
    "finally:\n",
    "    driver.quit()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "81e004ea",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "OK -> C:\\Users\\User\\Desktop\\leaders_name_href_raw.csv，共 1 筆\n"
     ]
    }
   ],
   "source": [
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "import csv, os\n",
    "\n",
    "url = (\"https://www.fangraphs.com/leaders/major-league?\"\n",
    "       \"pos=all&stats=bat&lg=all&qual=y&type=0&ind=0&rost=0&age=0&filter=&players=0\"\n",
    "       \"&pageitems=30&startdate=&enddate=&team=0&month=0&season1=2020&season=2025&pagenum=1\")\n",
    "\n",
    "opts = Options()\n",
    "opts.add_argument(\"--start-maximized\")\n",
    "driver = webdriver.Chrome(options=opts)\n",
    "wait = WebDriverWait(driver, 20)\n",
    "\n",
    "try:\n",
    "    driver.get(url)\n",
    "    thead = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"table thead\")))\n",
    "    tbody = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"table tbody\")))\n",
    "\n",
    "    # 找出 Name 欄位索引（兼容 #Name / Name）\n",
    "    headers = [th.text.strip() for th in thead.find_elements(By.CSS_SELECTOR, \"th\")]\n",
    "    name_idx = next((i for i, h in enumerate(headers) if h.lower().endswith(\"name\")), 1)\n",
    "\n",
    "    raw_hrefs = []\n",
    "    for tr in tbody.find_elements(By.CSS_SELECTOR, \"tr\"):\n",
    "        tds = tr.find_elements(By.CSS_SELECTOR, \"td\")\n",
    "        if len(tds) > name_idx:\n",
    "            a = tds[name_idx].find_elements(By.CSS_SELECTOR, \"a\")\n",
    "            if a:\n",
    "                # 這行就是你要的 「href=\"\" 中的資訊」\n",
    "                href_raw = a[0].get_dom_attribute(\"href\")   # 例如：/players/luis-arraez/18568/stats?position=1B%2F2B\n",
    "                raw_hrefs.append([href_raw])\n",
    "\n",
    "                # 若同時想要絕對網址，可用：a[0].get_attribute(\"href\")\n",
    "\n",
    "    out_csv = os.path.join(os.path.expanduser(\"~\"), \"Desktop\", \"leaders_name_href_raw.csv\")\n",
    "    with open(out_csv, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "        csv.writer(f).writerows(raw_hrefs)\n",
    "\n",
    "    print(f\"OK -> {out_csv}，共 {len(raw_hrefs)} 筆\")\n",
    "finally:\n",
    "    driver.quit()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "28e08e4a",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "luis-arraez/18568\n",
      "freddie-freeman/5361\n",
      "aaron-judge/15640\n",
      "michael-brantley/4106\n",
      "trea-turner/16252\n",
      "xavier-edwards/22266\n",
      "yordan-alvarez/19556\n",
      "yandy-diaz/16578\n",
      "bo-bichette/19612\n",
      "ronald-acuna-jr/18401\n",
      "vladimir-guerrero-jr/19611\n",
      "bobby-witt-jr/25764\n",
      "harold-ramirez/14387\n",
      "jose-iglesias/10231\n",
      "bryce-harper/11579\n",
      "xander-bogaerts/12161\n",
      "corey-seager/13624\n",
      "donovan-solano/8623\n",
      "jose-altuve/5417\n",
      "brendan-donovan/24679\n",
      "nico-hoerner/21479\n",
      "masataka-yoshida/31837\n",
      "wander-franco/23667\n",
      "steven-kwan/24610\n",
      "starling-marte/9241\n",
      "gabriel-moreno/22664\n",
      "paul-goldschmidt/9218\n",
      "shohei-ohtani/19755\n",
      "juan-soto/20123\n",
      "ketel-marte/13613\n",
      "luis-arraez/18568\n",
      "freddie-freeman/5361\n",
      "aaron-judge/15640\n",
      "michael-brantley/4106\n",
      "trea-turner/16252\n",
      "xavier-edwards/22266\n",
      "yordan-alvarez/19556\n",
      "yandy-diaz/16578\n",
      "bo-bichette/19612\n",
      "ronald-acuna-jr/18401\n",
      "vladimir-guerrero-jr/19611\n",
      "bobby-witt-jr/25764\n",
      "harold-ramirez/14387\n",
      "jose-iglesias/10231\n",
      "bryce-harper/11579\n",
      "xander-bogaerts/12161\n",
      "corey-seager/13624\n",
      "donovan-solano/8623\n",
      "jose-altuve/5417\n",
      "brendan-donovan/24679\n",
      "nico-hoerner/21479\n",
      "masataka-yoshida/31837\n",
      "wander-franco/23667\n",
      "steven-kwan/24610\n",
      "starling-marte/9241\n",
      "gabriel-moreno/22664\n",
      "paul-goldschmidt/9218\n",
      "shohei-ohtani/19755\n",
      "juan-soto/20123\n",
      "ketel-marte/13613\n"
     ]
    }
   ],
   "source": [
    "import re\n",
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "\n",
    "url = (\"https://www.fangraphs.com/leaders/major-league?\"\n",
    "       \"pos=all&stats=bat&lg=all&qual=y&type=0&ind=0&rost=0&age=0&filter=&players=0\"\n",
    "       \"&pageitems=30&startdate=&enddate=&team=0&month=0&season1=2020&season=2025&pagenum=1\")\n",
    "\n",
    "pat = re.compile(r\"/players/(.*?)/stats\\?\")  # 擷取中間 ... 部分\n",
    "\n",
    "opts = Options()\n",
    "opts.add_argument(\"--start-maximized\")\n",
    "driver = webdriver.Chrome(options=opts)\n",
    "\n",
    "try:\n",
    "    driver.get(url)\n",
    "    # 取得每列 Name 欄位的 <a>\n",
    "    links = driver.find_elements(By.CSS_SELECTOR, \"table tbody tr td[data-col-id='Name'] a\")\n",
    "    mids = []\n",
    "    for a in links:\n",
    "        href = a.get_dom_attribute(\"href\") or \"\"   # 如：/players/luis-arraez/18568/stats?position=1B%2F2B\n",
    "        m = pat.search(href)\n",
    "        if m:\n",
    "            mid = m.group(1)                       # 例：'luis-arraez/18568'\n",
    "            mids.append(mid)\n",
    "            print(mid)\n",
    "\n",
    "    # 若你想分開拿「slug」與「id」：\n",
    "    # slug, pid = mid.split(\"/\")  # slug='luis-arraez', pid='18568'\n",
    "\n",
    "finally:\n",
    "    driver.quit()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "9354c280",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "OK -> C:\\Users\\User\\Desktop\\leaders_name_mid.csv，0 筆\n"
     ]
    }
   ],
   "source": [
    "import re, csv, os\n",
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "\n",
    "url = (\"https://www.fangraphs.com/leaders/major-league?\"\n",
    "       \"pos=all&stats=bat&lg=all&qual=y&type=0&ind=0&rost=0&age=0&filter=&players=0\"\n",
    "       \"&pageitems=30&startdate=&enddate=&team=0&month=0&season1=2020&season=2025&pagenum=1\")\n",
    "\n",
    "pat = re.compile(r\"/players/(.*?)/stats\\?\")  # 擷取 players/ 和 /stats? 中間的字串\n",
    "\n",
    "opts = Options()\n",
    "opts.add_argument(\"--start-maximized\")\n",
    "driver = webdriver.Chrome(options=opts)\n",
    "wait = WebDriverWait(driver, 20)\n",
    "\n",
    "out_csv = r\"C:\\Users\\User\\Desktop\\leaders_name_mid.csv\"\n",
    "\n",
    "try:\n",
    "    driver.get(url)\n",
    "    # 等待表頭與表身\n",
    "    thead = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"table thead\")))\n",
    "    tbody = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"table tbody\")))\n",
    "\n",
    "    # 找 Name 欄位索引（兼容 #Name/Name）\n",
    "    headers = [th.text.strip() for th in thead.find_elements(By.CSS_SELECTOR, \"th\")]\n",
    "    name_idx = next((i for i, h in enumerate(headers) if h.lower().endswith(\"name\")), 1)\n",
    "\n",
    "    rows = []\n",
    "    for tr in tbody.find_elements(By.CSS_SELECTOR, \"tr\"):\n",
    "        tds = tr.find_elements(By.CSS_SELECTOR, \"td\")\n",
    "        if len(tds) <= name_idx:\n",
    "            continue\n",
    "        # Name\n",
    "        a = tds[name_idx].find_elements(By.CSS_SELECTOR, \"a\")\n",
    "        if not a:\n",
    "            continue\n",
    "        link = a[0]\n",
    "        name = link.text.strip()\n",
    "        href_raw = link.get_dom_attribute(\"href\") or \"\"   # 相對路徑，例：/players/luis-arraez/18568/stats?...\n",
    "        m = pat.search(href_raw)\n",
    "        if not m:\n",
    "            continue\n",
    "        mid = m.group(1)                                  # 例：luis-arraez/18568\n",
    "        parts = mid.split(\"/\")\n",
    "        slug = parts[0] if parts else \"\"\n",
    "        player_id = parts[1] if len(parts) > 1 else \"\"\n",
    "\n",
    "        rows.append([name, slug, player_id, mid, href_raw])\n",
    "\n",
    "    # 輸出 CSV\n",
    "    with open(out_csv, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "        w = csv.writer(f)\n",
    "        w.writerow([\"Name\", \"slug\", \"player_id\", \"mid\", \"href_raw\"])\n",
    "        w.writerows(rows)\n",
    "\n",
    "    print(f\"OK -> {out_csv}，{len(rows)} 筆\")\n",
    "finally:\n",
    "    driver.quit()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "7d6c7937",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "luis-arraez/18568\n",
      "freddie-freeman/5361\n",
      "aaron-judge/15640\n",
      "michael-brantley/4106\n",
      "trea-turner/16252\n",
      "xavier-edwards/22266\n",
      "yordan-alvarez/19556\n",
      "yandy-diaz/16578\n",
      "bo-bichette/19612\n",
      "ronald-acuna-jr/18401\n",
      "vladimir-guerrero-jr/19611\n",
      "bobby-witt-jr/25764\n",
      "harold-ramirez/14387\n",
      "jose-iglesias/10231\n",
      "bryce-harper/11579\n",
      "xander-bogaerts/12161\n",
      "corey-seager/13624\n",
      "donovan-solano/8623\n",
      "jose-altuve/5417\n",
      "brendan-donovan/24679\n",
      "nico-hoerner/21479\n",
      "masataka-yoshida/31837\n",
      "wander-franco/23667\n",
      "steven-kwan/24610\n",
      "starling-marte/9241\n",
      "gabriel-moreno/22664\n",
      "paul-goldschmidt/9218\n",
      "shohei-ohtani/19755\n",
      "juan-soto/20123\n",
      "ketel-marte/13613\n",
      "luis-arraez/18568\n",
      "freddie-freeman/5361\n",
      "aaron-judge/15640\n",
      "michael-brantley/4106\n",
      "trea-turner/16252\n",
      "xavier-edwards/22266\n",
      "yordan-alvarez/19556\n",
      "yandy-diaz/16578\n",
      "bo-bichette/19612\n",
      "ronald-acuna-jr/18401\n",
      "vladimir-guerrero-jr/19611\n",
      "bobby-witt-jr/25764\n",
      "harold-ramirez/14387\n",
      "jose-iglesias/10231\n",
      "bryce-harper/11579\n",
      "xander-bogaerts/12161\n",
      "corey-seager/13624\n",
      "donovan-solano/8623\n",
      "jose-altuve/5417\n",
      "brendan-donovan/24679\n",
      "nico-hoerner/21479\n",
      "masataka-yoshida/31837\n",
      "wander-franco/23667\n",
      "steven-kwan/24610\n",
      "starling-marte/9241\n",
      "gabriel-moreno/22664\n",
      "paul-goldschmidt/9218\n",
      "shohei-ohtani/19755\n",
      "juan-soto/20123\n",
      "ketel-marte/13613\n",
      "OK -> C:\\Users\\User\\Desktop\\leaders_name_mid.csv，60 筆\n"
     ]
    }
   ],
   "source": [
    "import re, csv, os\n",
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "\n",
    "url = (\"https://www.fangraphs.com/leaders/major-league?\"\n",
    "       \"pos=all&stats=bat&lg=all&qual=y&type=0&ind=0&rost=0&age=0&filter=&players=0\"\n",
    "       \"&pageitems=30&startdate=&enddate=&team=0&month=0&season1=2020&season=2025&pagenum=1\")\n",
    "\n",
    "pat = re.compile(r\"/players/(.*?)/stats\\?\")  # 擷取中間 ... 部分\n",
    "\n",
    "opts = Options()\n",
    "opts.add_argument(\"--start-maximized\")\n",
    "driver = webdriver.Chrome(options=opts)\n",
    "\n",
    "try:\n",
    "    driver.get(url)\n",
    "    links = driver.find_elements(By.CSS_SELECTOR, \"table tbody tr td[data-col-id='Name'] a\")\n",
    "\n",
    "    records = []  # 存 CSV 的列\n",
    "    for a in links:\n",
    "        name = a.text.strip()\n",
    "        href_raw = a.get_dom_attribute(\"href\") or \"\"  # 相對路徑，如 /players/luis-arraez/18568/stats?...\n",
    "        m = pat.search(href_raw)\n",
    "        if not m:\n",
    "            continue\n",
    "        mid = m.group(1)                 # 例：luis-arraez/18568\n",
    "        parts = mid.split(\"/\")\n",
    "        slug = parts[0] if parts else \"\"\n",
    "        player_id = parts[1] if len(parts) > 1 else \"\"\n",
    "        records.append([name, slug, player_id, mid, href_raw])\n",
    "        print(mid)\n",
    "\n",
    "    # 輸出 CSV\n",
    "    out_csv = os.path.join(os.path.expanduser(\"~\"), \"Desktop\", \"leaders_name_mid.csv\")\n",
    "    with open(out_csv, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "        w = csv.writer(f)\n",
    "        w.writerow([\"Name\", \"slug\", \"player_id\", \"mid\", \"href_raw\"])\n",
    "        w.writerows(records)\n",
    "\n",
    "    print(f\"OK -> {out_csv}，{len(records)} 筆\")\n",
    "finally:\n",
    "    driver.quit()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "33d8e97f",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "OK -> C:\\Users\\User\\Desktop\\leaders_name_fullurl.csv，60 筆\n"
     ]
    }
   ],
   "source": [
    "import re, csv, os\n",
    "from urllib.parse import urljoin\n",
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "\n",
    "base = \"https://www.fangraphs.com\"\n",
    "url = (\"https://www.fangraphs.com/leaders/major-league?\"\n",
    "       \"pos=all&stats=bat&lg=all&qual=y&type=0&ind=0&rost=0&age=0&filter=&players=0\"\n",
    "       \"&pageitems=30&startdate=&enddate=&team=0&month=0&season1=2020&season=2025&pagenum=1\")\n",
    "\n",
    "pat = re.compile(r\"/players/(.*?)/stats\\?\")\n",
    "\n",
    "opts = Options()\n",
    "opts.add_argument(\"--start-maximized\")\n",
    "driver = webdriver.Chrome(options=opts)\n",
    "\n",
    "try:\n",
    "    driver.get(url)\n",
    "    links = driver.find_elements(By.CSS_SELECTOR, \"table tbody tr td[data-col-id='Name'] a\")\n",
    "\n",
    "    rows = []\n",
    "    for a in links:\n",
    "        name = a.text.strip()\n",
    "        # 相對路徑（原始 DOM）與絕對路徑（解析後）\n",
    "        href_raw = a.get_dom_attribute(\"href\") or \"\"\n",
    "        href_abs = a.get_attribute(\"href\") or urljoin(base, href_raw)\n",
    "\n",
    "        m = pat.search(href_raw or href_abs)\n",
    "        if not m:\n",
    "            continue\n",
    "        mid = m.group(1)              # e.g. luis-arraez/18568\n",
    "        parts = mid.split(\"/\")\n",
    "        slug = parts[0] if parts else \"\"\n",
    "        pid = parts[1] if len(parts) > 1 else \"\"\n",
    "\n",
    "        rows.append([name, slug, pid, mid, href_abs])\n",
    "\n",
    "    out_csv = os.path.join(os.path.expanduser(\"~\"), \"Desktop\", \"leaders_name_fullurl.csv\")\n",
    "    with open(out_csv, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "        csv.writer(f).writerows([[\"Name\",\"slug\",\"player_id\",\"mid\",\"url_full\"], *rows])\n",
    "\n",
    "    print(f\"OK -> {out_csv}，{len(rows)} 筆\")\n",
    "finally:\n",
    "    driver.quit()\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "2ae09d30",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "OK -> C:\\Users\\User\\Desktop\\leaders_name_fullurl_p1_to_p13.csv，共 764 筆，頁數 1..13\n"
     ]
    }
   ],
   "source": [
    "import re, csv, os, time\n",
    "from urllib.parse import urljoin\n",
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "\n",
    "# 目標頁面樣板（僅 pagenum 會變）\n",
    "URL_TPL = (\"https://www.fangraphs.com/leaders/major-league?\"\n",
    "           \"pos=all&stats=bat&lg=all&qual=y&type=0&ind=0&rost=0&age=0&filter=&players=0\"\n",
    "           \"&pageitems=30&startdate=&enddate=&team=0&month=0&season1=2020&season=2025&pagenum={i}&csv\")\n",
    "\n",
    "BASE = \"https://www.fangraphs.com\"\n",
    "PAT = re.compile(r\"/players/(.*?)/stats\\?\")   # 擷取 /players/ 和 /stats? 中間字串\n",
    "\n",
    "opts = Options()\n",
    "opts.add_argument(\"--start-maximized\")\n",
    "driver = webdriver.Chrome(options=opts)\n",
    "wait = WebDriverWait(driver, 20)\n",
    "\n",
    "all_rows = []\n",
    "\n",
    "try:\n",
    "    for i in range(1, 14):  # i = 1..13\n",
    "        url = URL_TPL.format(i=i)\n",
    "        driver.get(url)\n",
    "\n",
    "        # 等表格載入（thead+tbody 都要有）\n",
    "        thead = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"table thead\")))\n",
    "        tbody = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"table tbody\")))\n",
    "        # 找 Name 欄位索引（兼容 #Name/Name）\n",
    "        headers = [th.text.strip() for th in thead.find_elements(By.CSS_SELECTOR, \"th\")]\n",
    "        name_idx = next((k for k, h in enumerate(headers) if h.lower().endswith(\"name\")), 1)\n",
    "\n",
    "        links = driver.find_elements(By.CSS_SELECTOR, \"table tbody tr td[data-col-id='Name'] a\")\n",
    "        for a in links:\n",
    "            name = a.text.strip()\n",
    "            href_raw = a.get_dom_attribute(\"href\") or \"\"    # 相對路徑\n",
    "            href_abs = a.get_attribute(\"href\") or urljoin(BASE, href_raw)  # 絕對網址\n",
    "\n",
    "            m = PAT.search(href_raw or href_abs)\n",
    "            if not m:\n",
    "                continue\n",
    "            mid = m.group(1)                  # 例：luis-arraez/18568\n",
    "            parts = mid.split(\"/\")\n",
    "            slug = parts[0] if parts else \"\"\n",
    "            pid = parts[1] if len(parts) > 1 else \"\"\n",
    "\n",
    "            all_rows.append([i, name, slug, pid, mid, href_abs])\n",
    "\n",
    "        # 輕微停頓，降低被風控機率\n",
    "        time.sleep(0.6)\n",
    "\n",
    "finally:\n",
    "    driver.quit()\n",
    "\n",
    "# 輸出 CSV\n",
    "out_csv = os.path.join(os.path.expanduser(\"~\"), \"Desktop\", \"leaders_name_fullurl_p1_to_p13.csv\")\n",
    "with open(out_csv, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "    w = csv.writer(f)\n",
    "    w.writerow([\"page\", \"Name\", \"slug\", \"player_id\", \"mid\", \"url_full\"])\n",
    "    w.writerows(all_rows)\n",
    "\n",
    "print(f\"OK -> {out_csv}，共 {len(all_rows)} 筆，頁數 1..13\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": null,
   "id": "b6d7ed0f",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[1/232] OK：Dominic Smith -> C:\\Users\\User\\Desktop\\球員資料\\players\\dominic-smith_15653_standard.csv\n",
      "[2/232] OK：Geraldo Perdomo -> C:\\Users\\User\\Desktop\\球員資料\\players\\geraldo-perdomo_22799_standard.csv\n",
      "[3/232] OK：J.P. Crawford -> C:\\Users\\User\\Desktop\\球員資料\\players\\jp-crawford_15491_standard.csv\n",
      "[4/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\dansby-swanson_18314_standard.csv\n",
      "[5/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\andres-gimenez_19950_standard.csv\n",
      "[6/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\trevor-story_12564_standard.csv\n",
      "[7/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\andrew-vaughn_26197_standard.csv\n",
      "[8/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\joey-wendle_13853_standard.csv\n",
      "[9/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\kebryan-hayes_18577_standard.csv\n",
      "[10/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\harrison-bader_18030_standard.csv\n",
      "[11/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\tommy-edman_19470_standard.csv\n",
      "[12/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\jon-berti_12037_standard.csv\n",
      "[13/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\jurickson-profar_10815_standard.csv\n",
      "[14/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\luis-rengifo_19858_standard.csv\n",
      "[15/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\willson-contreras_11609_standard.csv\n",
      "[16/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\masyn-winn_27479_standard.csv\n",
      "[17/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\taylor-ward_17548_standard.csv\n",
      "[18/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\thairo-estrada_16426_standard.csv\n",
      "[19/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\cedric-mullins_17929_standard.csv\n",
      "[20/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\pete-alonso_19251_standard.csv\n",
      "[21/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\ezequiel-duran_23733_standard.csv\n",
      "[22/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\jesse-winker_13590_standard.csv\n",
      "[23/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\bryan-de-la-cruz_19600_standard.csv\n",
      "[24/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\marcus-semien_12533_standard.csv\n",
      "[25/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\jake-fraley_19260_standard.csv\n",
      "[26/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\josh-bell_13145_standard.csv\n",
      "[27/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\jorge-polanco_13152_standard.csv\n",
      "[28/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\cody-bellinger_15998_standard.csv\n",
      "[29/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\randy-arozarena_19290_standard.csv\n",
      "[30/232] OK： -> C:\\Users\\User\\Desktop\\球員資料\\players\\josh-lowe_19953_standard.csv\n",
      "[31/232] OK：Jesús Aguilar -> C:\\Users\\User\\Desktop\\球員資料\\players\\jesus-aguilar_11342_standard.csv\n",
      "[32/232] OK：Michael Busch -> C:\\Users\\User\\Desktop\\球員資料\\players\\michael-busch_26319_standard.csv\n",
      "[33/232] OK：CJ Abrams -> C:\\Users\\User\\Desktop\\球員資料\\players\\cj-abrams_25768_standard.csv\n",
      "[34/232] OK：Jonathan India -> C:\\Users\\User\\Desktop\\球員資料\\players\\jonathan-india_21523_standard.csv\n",
      "[35/232] OK：J.D. Davis -> C:\\Users\\User\\Desktop\\球員資料\\players\\jd-davis_16219_standard.csv\n",
      "[36/232] OK：Wilmer Flores -> C:\\Users\\User\\Desktop\\球員資料\\players\\wilmer-flores_5827_standard.csv\n",
      "[37/232] OK：Kyle Farmer -> C:\\Users\\User\\Desktop\\球員資料\\players\\kyle-farmer_14813_standard.csv\n",
      "[38/232] OK：Kolten Wong -> C:\\Users\\User\\Desktop\\球員資料\\players\\kolten-wong_12532_standard.csv\n",
      "[39/232] OK：Kris Bryant -> C:\\Users\\User\\Desktop\\球員資料\\players\\kris-bryant_15429_standard.csv\n",
      "[40/232] OK：Keibert Ruiz -> C:\\Users\\User\\Desktop\\球員資料\\players\\keibert-ruiz_19610_standard.csv\n",
      "[41/232] OK：Yan Gomes -> C:\\Users\\User\\Desktop\\球員資料\\players\\yan-gomes_9627_standard.csv\n",
      "[42/232] OK：Christian Walker -> C:\\Users\\User\\Desktop\\球員資料\\players\\christian-walker_13419_standard.csv\n",
      "[43/232] OK：Mark Canha -> C:\\Users\\User\\Desktop\\球員資料\\players\\mark-canha_11445_standard.csv\n",
      "[44/232] OK：Jazz Chisholm Jr. -> C:\\Users\\User\\Desktop\\球員資料\\players\\jazz-chisholm-jr_20454_standard.csv\n",
      "[45/232] OK：Ian Happ -> C:\\Users\\User\\Desktop\\球員資料\\players\\ian-happ_17919_standard.csv\n",
      "[46/232] OK：Jake Burger -> C:\\Users\\User\\Desktop\\球員資料\\players\\jake-burger_22275_standard.csv\n",
      "[47/232] OK：César Hernández -> C:\\Users\\User\\Desktop\\球員資料\\players\\cesar-hernandez_10556_standard.csv\n",
      "[48/232] OK：Ceddanne Rafaela -> C:\\Users\\User\\Desktop\\球員資料\\players\\ceddanne-rafaela_24262_standard.csv\n",
      "[49/232] OK：Nolan Jones -> C:\\Users\\User\\Desktop\\球員資料\\players\\nolan-jones_20529_standard.csv\n",
      "[50/232] OK：Jake Cronenworth -> C:\\Users\\User\\Desktop\\球員資料\\players\\jake-cronenworth_18036_standard.csv\n",
      "[51/232] OK：Chas McCormick -> C:\\Users\\User\\Desktop\\球員資料\\players\\chas-mccormick_19599_standard.csv\n",
      "[52/232] OK：Wyatt Langford -> C:\\Users\\User\\Desktop\\球員資料\\players\\wyatt-langford_33333_standard.csv\n",
      "[53/232] OK：Jacob Young -> C:\\Users\\User\\Desktop\\球員資料\\players\\jacob-young_29931_standard.csv\n",
      "[54/232] OK：Zach Neto -> C:\\Users\\User\\Desktop\\球員資料\\players\\zach-neto_31347_standard.csv\n",
      "[55/232] OK：Tyler Freeman -> C:\\Users\\User\\Desktop\\球員資料\\players\\tyler-freeman_22532_standard.csv\n",
      "[56/232] OK：Brandon Crawford -> C:\\Users\\User\\Desktop\\球員資料\\players\\brandon-crawford_5343_standard.csv\n",
      "[57/232] OK：Nicky Lopez -> C:\\Users\\User\\Desktop\\球員資料\\players\\nicky-lopez_19339_standard.csv\n",
      "[58/232] OK：Pavin Smith -> C:\\Users\\User\\Desktop\\球員資料\\players\\pavin-smith_19892_standard.csv\n",
      "[59/232] OK：Lenyn Sosa -> C:\\Users\\User\\Desktop\\球員資料\\players\\lenyn-sosa_22896_standard.csv\n",
      "[60/232] OK：Kevin Newman -> C:\\Users\\User\\Desktop\\球員資料\\players\\kevin-newman_17696_standard.csv\n",
      "[61/232] OK：Austin Slater -> C:\\Users\\User\\Desktop\\球員資料\\players\\austin-slater_16153_standard.csv\n",
      "[62/232] OK：Evan Longoria -> C:\\Users\\User\\Desktop\\球員資料\\players\\evan-longoria_9368_standard.csv\n",
      "[63/232] OK：Connor Wong -> C:\\Users\\User\\Desktop\\球員資料\\players\\connor-wong_19896_standard.csv\n",
      "[64/232] OK：Jonathan Schoop -> C:\\Users\\User\\Desktop\\球員資料\\players\\jonathan-schoop_11265_standard.csv\n",
      "[65/232] OK：Elias Díaz -> C:\\Users\\User\\Desktop\\球員資料\\players\\elias-diaz_11680_standard.csv\n",
      "[66/232] OK：Brandon Lowe -> C:\\Users\\User\\Desktop\\球員資料\\players\\brandon-lowe_18882_standard.csv\n",
      "[67/232] OK：Trey Mancini -> C:\\Users\\User\\Desktop\\球員資料\\players\\trey-mancini_15149_standard.csv\n",
      "[68/232] OK：Myles Straw -> C:\\Users\\User\\Desktop\\球員資料\\players\\myles-straw_17620_standard.csv\n",
      "[69/232] OK：Willi Castro -> C:\\Users\\User\\Desktop\\球員資料\\players\\willi-castro_17338_standard.csv\n",
      "[70/232] OK：Emmanuel Rivera -> C:\\Users\\User\\Desktop\\球員資料\\players\\emmanuel-rivera_19890_standard.csv\n",
      "[71/232] OK：Christian Vázquez -> C:\\Users\\User\\Desktop\\球員資料\\players\\christian-vazquez_9774_standard.csv\n",
      "[72/232] OK：Ildemaro Vargas -> C:\\Users\\User\\Desktop\\球員資料\\players\\ildemaro-vargas_13324_standard.csv\n",
      "[73/232] OK：Travis d'Arnaud -> C:\\Users\\User\\Desktop\\球員資料\\players\\travis-darnaud_7739_standard.csv\n",
      "[74/232] OK：Elvis Andrus -> C:\\Users\\User\\Desktop\\球員資料\\players\\elvis-andrus_8709_standard.csv\n",
      "[75/232] OK：Nick Gordon -> C:\\Users\\User\\Desktop\\球員資料\\players\\nick-gordon_16337_standard.csv\n",
      "[76/232] OK：Mike Tauchman -> C:\\Users\\User\\Desktop\\球員資料\\players\\mike-tauchman_15274_standard.csv\n",
      "[77/232] OK：Jake Meyers -> C:\\Users\\User\\Desktop\\球員資料\\players\\jake-meyers_20308_standard.csv\n",
      "[78/232] OK：Mickey Moniak -> C:\\Users\\User\\Desktop\\球員資料\\players\\mickey-moniak_19956_standard.csv\n",
      "[79/232] OK：Jeimer Candelario -> C:\\Users\\User\\Desktop\\球員資料\\players\\jeimer-candelario_13621_standard.csv\n",
      "[80/232] OK：Spencer Steer -> C:\\Users\\User\\Desktop\\球員資料\\players\\spencer-steer_26323_standard.csv\n",
      "[81/232] OK：Michael Massey -> C:\\Users\\User\\Desktop\\球員資料\\players\\michael-massey_27684_standard.csv\n",
      "[82/232] OK：Yoán Moncada -> C:\\Users\\User\\Desktop\\球員資料\\players\\yoan-moncada_17232_standard.csv\n",
      "[83/232] OK：Ramón Laureano -> C:\\Users\\User\\Desktop\\球員資料\\players\\ramon-laureano_17128_standard.csv\n",
      "[84/232] OK：Josh Rojas -> C:\\Users\\User\\Desktop\\球員資料\\players\\josh-rojas_19734_standard.csv\n",
      "[85/232] OK：Alex Call -> C:\\Users\\User\\Desktop\\球員資料\\players\\alex-call_19296_standard.csv\n",
      "[86/232] OK：Victor Robles -> C:\\Users\\User\\Desktop\\球員資料\\players\\victor-robles_18363_standard.csv\n",
      "[87/232] OK：Lars Nootbaar -> C:\\Users\\User\\Desktop\\球員資料\\players\\lars-nootbaar_21454_standard.csv\n",
      "[88/232] OK：Anthony Rendon -> C:\\Users\\User\\Desktop\\球員資料\\players\\anthony-rendon_12861_standard.csv\n",
      "[89/232] OK：Lawrence Butler -> C:\\Users\\User\\Desktop\\球員資料\\players\\lawrence-butler_22542_standard.csv\n",
      "[90/232] OK：Reese McGuire -> C:\\Users\\User\\Desktop\\球員資料\\players\\reese-mcguire_15674_standard.csv\n",
      "[91/232] OK：Franmil Reyes -> C:\\Users\\User\\Desktop\\球員資料\\players\\franmil-reyes_14566_standard.csv\n",
      "[92/232] OK：Ha-Seong Kim -> C:\\Users\\User\\Desktop\\球員資料\\players\\ha-seong-kim_27506_standard.csv\n",
      "[93/232] OK：Jared Walsh -> C:\\Users\\User\\Desktop\\球員資料\\players\\jared-walsh_18607_standard.csv\n",
      "[94/232] OK：Victor Caratini -> C:\\Users\\User\\Desktop\\球員資料\\players\\victor-caratini_14968_standard.csv\n",
      "[95/232] OK：Connor Joe -> C:\\Users\\User\\Desktop\\球員資料\\players\\connor-joe_16572_standard.csv\n",
      "[96/232] OK：Trevor Larnach -> C:\\Users\\User\\Desktop\\球員資料\\players\\trevor-larnach_21501_standard.csv\n",
      "[97/232] OK：Tommy Pham -> C:\\Users\\User\\Desktop\\球員資料\\players\\tommy-pham_2967_standard.csv\n",
      "[98/232] OK：Joc Pederson -> C:\\Users\\User\\Desktop\\球員資料\\players\\joc-pederson_11899_standard.csv\n",
      "[99/232] OK：Lane Thomas -> C:\\Users\\User\\Desktop\\球員資料\\players\\lane-thomas_16939_standard.csv\n",
      "[100/232] OK：Tyler O'Neill -> C:\\Users\\User\\Desktop\\球員資料\\players\\tyler-oneill_15711_standard.csv\n",
      "[101/232] OK：Jordan Walker -> C:\\Users\\User\\Desktop\\球員資料\\players\\jordan-walker_27475_standard.csv\n",
      "[102/232] OK：Anthony Santander -> C:\\Users\\User\\Desktop\\球員資料\\players\\anthony-santander_14551_standard.csv\n",
      "[103/232] OK：Pete Crow-Armstrong -> C:\\Users\\User\\Desktop\\球員資料\\players\\pete-crow-armstrong_27769_standard.csv\n",
      "[104/232] OK：Luke Voit -> C:\\Users\\User\\Desktop\\球員資料\\players\\luke-voit_14811_standard.csv\n",
      "[105/232] OK：Willy Adames -> C:\\Users\\User\\Desktop\\球員資料\\players\\willy-adames_15986_standard.csv\n",
      "[106/232] OK：Ryan Jeffers -> C:\\Users\\User\\Desktop\\球員資料\\players\\ryan-jeffers_24618_standard.csv\n",
      "[107/232] OK：Mark Vientos -> C:\\Users\\User\\Desktop\\球員資料\\players\\mark-vientos_22184_standard.csv\n",
      "[108/232] OK：Kevin Kiermaier -> C:\\Users\\User\\Desktop\\球員資料\\players\\kevin-kiermaier_11038_standard.csv\n",
      "[109/232] OK：Joey Bart -> C:\\Users\\User\\Desktop\\球員資料\\players\\joey-bart_21524_standard.csv\n",
      "[110/232] OK：Jesús Sánchez -> C:\\Users\\User\\Desktop\\球員資料\\players\\jesus-sanchez_19913_standard.csv\n",
      "[111/232] OK：Ben Gamel -> C:\\Users\\User\\Desktop\\球員資料\\players\\ben-gamel_12160_standard.csv\n",
      "[112/232] OK：Brandon Drury -> C:\\Users\\User\\Desktop\\球員資料\\players\\brandon-drury_11615_standard.csv\n",
      "[113/232] OK：Avisaíl García -> C:\\Users\\User\\Desktop\\球員資料\\players\\avisail-garcia_5760_standard.csv\n",
      "[114/232] OK：Kevin Pillar -> C:\\Users\\User\\Desktop\\球員資料\\players\\kevin-pillar_12434_standard.csv\n",
      "[115/232] OK：Eduardo Escobar -> C:\\Users\\User\\Desktop\\球員資料\\players\\eduardo-escobar_6153_standard.csv\n",
      "[116/232] OK：Tony Kemp -> C:\\Users\\User\\Desktop\\球員資料\\players\\tony-kemp_14894_standard.csv\n",
      "[117/232] OK：Andrew McCutchen -> C:\\Users\\User\\Desktop\\球員資料\\players\\andrew-mccutchen_9847_standard.csv\n",
      "[118/232] OK：Aledmys Díaz -> C:\\Users\\User\\Desktop\\球員資料\\players\\aledmys-diaz_15937_standard.csv\n",
      "[119/232] OK：Ryan McMahon -> C:\\Users\\User\\Desktop\\球員資料\\players\\ryan-mcmahon_15112_standard.csv\n",
      "[120/232] OK：Kyle Isbel -> C:\\Users\\User\\Desktop\\球員資料\\players\\kyle-isbel_21614_standard.csv\n",
      "[121/232] OK：Owen Miller -> C:\\Users\\User\\Desktop\\球員資料\\players\\owen-miller_24655_standard.csv\n",
      "[122/232] OK：Adolis García -> C:\\Users\\User\\Desktop\\球員資料\\players\\adolis-garcia_19287_standard.csv\n",
      "[123/232] OK：LaMonte Wade Jr. -> C:\\Users\\User\\Desktop\\球員資料\\players\\lamonte-wade-jr_18126_standard.csv\n",
      "[124/232] OK：Rhys Hoskins -> C:\\Users\\User\\Desktop\\球員資料\\players\\rhys-hoskins_16472_standard.csv\n",
      "[125/232] OK：Michael Conforto -> C:\\Users\\User\\Desktop\\球員資料\\players\\michael-conforto_16376_standard.csv\n",
      "[126/232] OK：Hunter Renfroe -> C:\\Users\\User\\Desktop\\球員資料\\players\\hunter-renfroe_15464_standard.csv\n",
      "[127/232] OK：Isaac Paredes -> C:\\Users\\User\\Desktop\\球員資料\\players\\isaac-paredes_20036_standard.csv\n",
      "[128/232] OK：Giancarlo Stanton -> C:\\Users\\User\\Desktop\\球員資料\\players\\giancarlo-stanton_4949_standard.csv\n",
      "[129/232] OK：Tyrone Taylor -> C:\\Users\\User\\Desktop\\球員資料\\players\\tyrone-taylor_13675_standard.csv\n",
      "[130/232] OK：Josh Smith -> C:\\Users\\User\\Desktop\\球員資料\\players\\josh-smith_26396_standard.csv\n",
      "[131/232] OK：Leody Taveras -> C:\\Users\\User\\Desktop\\球員資料\\players\\leody-taveras_18900_standard.csv\n",
      "[132/232] OK：Jared Triolo -> C:\\Users\\User\\Desktop\\球員資料\\players\\jared-triolo_25807_standard.csv\n",
      "[133/232] OK：Gavin Sheets -> C:\\Users\\User\\Desktop\\球員資料\\players\\gavin-sheets_19901_standard.csv\n",
      "[134/232] OK：Orlando Arcia -> C:\\Users\\User\\Desktop\\球員資料\\players\\orlando-arcia_13185_standard.csv\n",
      "[135/232] OK：Luis Torrens -> C:\\Users\\User\\Desktop\\球員資料\\players\\luis-torrens_15905_standard.csv\n",
      "[136/232] OK：Brenton Doyle -> C:\\Users\\User\\Desktop\\球員資料\\players\\brenton-doyle_25479_standard.csv\n",
      "[137/232] OK：Anthony Rizzo -> C:\\Users\\User\\Desktop\\球員資料\\players\\anthony-rizzo_3473_standard.csv\n",
      "[138/232] OK：Shea Langeliers -> C:\\Users\\User\\Desktop\\球員資料\\players\\shea-langeliers_25816_standard.csv\n",
      "[139/232] OK：Jose Trevino -> C:\\Users\\User\\Desktop\\球員資料\\players\\jose-trevino_16725_standard.csv\n",
      "[140/232] OK：Chris Taylor -> C:\\Users\\User\\Desktop\\球員資料\\players\\chris-taylor_13757_standard.csv\n",
      "[141/232] OK：Eddie Rosario -> C:\\Users\\User\\Desktop\\球員資料\\players\\eddie-rosario_12155_standard.csv\n",
      "[142/232] OK：Javier Báez -> C:\\Users\\User\\Desktop\\球員資料\\players\\javier-baez_12979_standard.csv\n",
      "[143/232] OK：Brian Anderson -> C:\\Users\\User\\Desktop\\球員資料\\players\\brian-anderson_18289_standard.csv\n",
      "[144/232] OK：Alek Thomas -> C:\\Users\\User\\Desktop\\球員資料\\players\\alek-thomas_23792_standard.csv\n",
      "[145/232] OK：Mitch Haniger -> C:\\Users\\User\\Desktop\\球員資料\\players\\mitch-haniger_14274_standard.csv\n",
      "[146/232] OK：Luis Urías -> C:\\Users\\User\\Desktop\\球員資料\\players\\luis-urias_16622_standard.csv\n",
      "[147/232] OK：Joey Ortiz -> C:\\Users\\User\\Desktop\\球員資料\\players\\joey-ortiz_25493_standard.csv\n",
      "[148/232] OK：Dylan Carlson -> C:\\Users\\User\\Desktop\\球員資料\\players\\dylan-carlson_20126_standard.csv\n",
      "[149/232] OK：Max Kepler -> C:\\Users\\User\\Desktop\\球員資料\\players\\max-kepler_12144_standard.csv\n",
      "[150/232] OK：James McCann -> C:\\Users\\User\\Desktop\\球員資料\\players\\james-mccann_12859_standard.csv\n",
      "[151/232] OK：Maikel Franco -> C:\\Users\\User\\Desktop\\球員資料\\players\\maikel-franco_12179_standard.csv\n",
      "[152/232] OK：Oneil Cruz -> C:\\Users\\User\\Desktop\\球員資料\\players\\oneil-cruz_21711_standard.csv\n",
      "[153/232] OK：Mike Yastrzemski -> C:\\Users\\User\\Desktop\\球員資料\\players\\mike-yastrzemski_14854_standard.csv\n",
      "[154/232] OK：Rowdy Tellez -> C:\\Users\\User\\Desktop\\球員資料\\players\\rowdy-tellez_15679_standard.csv\n",
      "[155/232] OK：Enrique Hernández -> C:\\Users\\User\\Desktop\\球員資料\\players\\enrique-hernandez_10472_standard.csv\n",
      "[156/232] OK：Eric Haase -> C:\\Users\\User\\Desktop\\球員資料\\players\\eric-haase_14111_standard.csv\n",
      "[157/232] OK：Brett Baty -> C:\\Users\\User\\Desktop\\球員資料\\players\\brett-baty_26123_standard.csv\n",
      "[158/232] OK：Garrett Hampson -> C:\\Users\\User\\Desktop\\球員資料\\players\\garrett-hampson_19262_standard.csv\n",
      "[159/232] OK：Luke Raley -> C:\\Users\\User\\Desktop\\球員資料\\players\\luke-raley_19354_standard.csv\n",
      "[160/232] OK：Matt Chapman -> C:\\Users\\User\\Desktop\\球員資料\\players\\matt-chapman_16505_standard.csv\n",
      "[161/232] OK：Carson Kelly -> C:\\Users\\User\\Desktop\\球員資料\\players\\carson-kelly_13620_standard.csv\n",
      "[162/232] OK：Logan O'Hoppe -> C:\\Users\\User\\Desktop\\球員資料\\players\\logan-ohoppe_24729_standard.csv\n",
      "[163/232] OK：Zach McKinstry -> C:\\Users\\User\\Desktop\\球員資料\\players\\zach-mckinstry_19392_standard.csv\n",
      "[164/232] OK：Joey Votto -> C:\\Users\\User\\Desktop\\球員資料\\players\\joey-votto_4314_standard.csv\n",
      "[165/232] OK：Jorge Soler -> C:\\Users\\User\\Desktop\\球員資料\\players\\jorge-soler_14221_standard.csv\n",
      "[166/232] OK：Jason Heyward -> C:\\Users\\User\\Desktop\\球員資料\\players\\jason-heyward_4940_standard.csv\n",
      "[167/232] OK：Francisco Alvarez -> C:\\Users\\User\\Desktop\\球員資料\\players\\francisco-alvarez_26121_standard.csv\n",
      "[168/232] OK：Patrick Bailey -> C:\\Users\\User\\Desktop\\球員資料\\players\\patrick-bailey_27478_standard.csv\n",
      "[169/232] OK：Eugenio Suárez -> C:\\Users\\User\\Desktop\\球員資料\\players\\eugenio-suarez_12552_standard.csv\n",
      "[170/232] OK：Kyle Schwarber -> C:\\Users\\User\\Desktop\\球員資料\\players\\kyle-schwarber_16478_standard.csv\n",
      "[171/232] OK：Robbie Grossman -> C:\\Users\\User\\Desktop\\球員資料\\players\\robbie-grossman_5254_standard.csv\n",
      "[172/232] OK：José Caballero -> C:\\Users\\User\\Desktop\\球員資料\\players\\jose-caballero_23401_standard.csv\n",
      "[173/232] OK：Mike Moustakas -> C:\\Users\\User\\Desktop\\球員資料\\players\\mike-moustakas_4892_standard.csv\n",
      "[174/232] OK：Sean Murphy -> C:\\Users\\User\\Desktop\\球員資料\\players\\sean-murphy_19352_standard.csv\n",
      "[175/232] OK：Nick Ahmed -> C:\\Users\\User\\Desktop\\球員資料\\players\\nick-ahmed_12147_standard.csv\n",
      "[176/232] OK：Spencer Torkelson -> C:\\Users\\User\\Desktop\\球員資料\\players\\spencer-torkelson_27465_standard.csv\n",
      "[177/232] OK：Daulton Varsho -> C:\\Users\\User\\Desktop\\球員資料\\players\\daulton-varsho_19918_standard.csv\n",
      "[178/232] OK：Daniel Vogelbach -> C:\\Users\\User\\Desktop\\球員資料\\players\\daniel-vogelbach_14130_standard.csv\n",
      "[179/232] OK：Yasmani Grandal -> C:\\Users\\User\\Desktop\\球員資料\\players\\yasmani-grandal_11368_standard.csv\n",
      "[180/232] OK：Cal Raleigh -> C:\\Users\\User\\Desktop\\球員資料\\players\\cal-raleigh_21534_standard.csv\n",
      "[181/232] OK：Michael A. Taylor -> C:\\Users\\User\\Desktop\\球員資料\\players\\michael-a-taylor_11489_standard.csv\n",
      "[182/232] OK：Jonah Heim -> C:\\Users\\User\\Desktop\\球員資料\\players\\jonah-heim_16930_standard.csv\n",
      "[183/232] OK：Jacob Stallings -> C:\\Users\\User\\Desktop\\球員資料\\players\\jacob-stallings_13723_standard.csv\n",
      "[184/232] OK：Omar Narváez -> C:\\Users\\User\\Desktop\\球員資料\\players\\omar-narvaez_13338_standard.csv\n",
      "[185/232] OK：Kyle Higashioka -> C:\\Users\\User\\Desktop\\球員資料\\players\\kyle-higashioka_5517_standard.csv\n",
      "[186/232] OK：Akil Baddoo -> C:\\Users\\User\\Desktop\\球員資料\\players\\akil-baddoo_22168_standard.csv\n",
      "[187/232] OK：Will Benson -> C:\\Users\\User\\Desktop\\球員資料\\players\\will-benson_21853_standard.csv\n",
      "[188/232] OK：Nick Fortes -> C:\\Users\\User\\Desktop\\球員資料\\players\\nick-fortes_21538_standard.csv\n",
      "[189/232] OK：Jace Peterson -> C:\\Users\\User\\Desktop\\球員資料\\players\\jace-peterson_12325_standard.csv\n",
      "[190/232] OK：Nick Senzel -> C:\\Users\\User\\Desktop\\球員資料\\players\\nick-senzel_19293_standard.csv\n",
      "[191/232] OK：Abraham Toro -> C:\\Users\\User\\Desktop\\球員資料\\players\\abraham-toro_19844_standard.csv\n",
      "[192/232] OK：Hunter Dozier -> C:\\Users\\User\\Desktop\\球員資料\\players\\hunter-dozier_15117_standard.csv\n",
      "[193/232] OK：Seth Brown -> C:\\Users\\User\\Desktop\\球員資料\\players\\seth-brown_18171_standard.csv\n",
      "[194/232] OK：Tucker Barnhart -> C:\\Users\\User\\Desktop\\球員資料\\players\\tucker-barnhart_10200_standard.csv\n",
      "[195/232] OK：Jake Cave -> C:\\Users\\User\\Desktop\\球員資料\\players\\jake-cave_14477_standard.csv\n",
      "[196/232] OK：Anthony Volpe -> C:\\Users\\User\\Desktop\\球員資料\\players\\anthony-volpe_27647_standard.csv\n",
      "[197/232] OK：Christopher Morel -> C:\\Users\\User\\Desktop\\球員資料\\players\\christopher-morel_21897_standard.csv\n",
      "[198/232] OK：Bobby Dalbec -> C:\\Users\\User\\Desktop\\球員資料\\players\\bobby-dalbec_19966_standard.csv\n",
      "[199/232] OK：Josh Donaldson -> C:\\Users\\User\\Desktop\\球員資料\\players\\josh-donaldson_5038_standard.csv\n",
      "[200/232] OK：Max Muncy -> C:\\Users\\User\\Desktop\\球員資料\\players\\max-muncy_13301_standard.csv\n",
      "[201/232] OK：Carlos Santana -> C:\\Users\\User\\Desktop\\球員資料\\players\\carlos-santana_2396_standard.csv\n",
      "[202/232] OK：Adam Duvall -> C:\\Users\\User\\Desktop\\球員資料\\players\\adam-duvall_10950_standard.csv\n",
      "[203/232] OK：Jorge Mateo -> C:\\Users\\User\\Desktop\\球員資料\\players\\jorge-mateo_17273_standard.csv\n",
      "[204/232] OK：Danny Jansen -> C:\\Users\\User\\Desktop\\球員資料\\players\\danny-jansen_16535_standard.csv\n",
      "[205/232] OK：Aaron Hicks -> C:\\Users\\User\\Desktop\\球員資料\\players\\aaron-hicks_5297_standard.csv\n",
      "[206/232] OK：Cavan Biggio -> C:\\Users\\User\\Desktop\\球員資料\\players\\cavan-biggio_19252_standard.csv\n",
      "[207/232] OK：Jo Adell -> C:\\Users\\User\\Desktop\\球員資料\\players\\jo-adell_20220_standard.csv\n",
      "[208/232] OK：Nolan Gorman -> C:\\Users\\User\\Desktop\\球員資料\\players\\nolan-gorman_22263_standard.csv\n",
      "[209/232] OK：Mitch Garver -> C:\\Users\\User\\Desktop\\球員資料\\players\\mitch-garver_15161_standard.csv\n",
      "[210/232] OK：Trent Grisham -> C:\\Users\\User\\Desktop\\球員資料\\players\\trent-grisham_18564_standard.csv\n",
      "[211/232] OK：Gabriel Arias -> C:\\Users\\User\\Desktop\\球員資料\\players\\gabriel-arias_22563_standard.csv\n",
      "[212/232] OK：JJ Bleday -> C:\\Users\\User\\Desktop\\球員資料\\players\\jj-bleday_26368_standard.csv\n",
      "[213/232] OK：MJ Melendez -> C:\\Users\\User\\Desktop\\球員資料\\players\\mj-melendez_22197_standard.csv\n",
      "[214/232] OK：Kole Calhoun -> C:\\Users\\User\\Desktop\\球員資料\\players\\kole-calhoun_11200_standard.csv\n",
      "[215/232] OK：Nick Allen -> C:\\Users\\User\\Desktop\\球員資料\\players\\nick-allen_22277_standard.csv\n",
      "[216/232] OK：Jarred Kelenic -> C:\\Users\\User\\Desktop\\球員資料\\players\\jarred-kelenic_22558_standard.csv\n",
      "[217/232] OK：Paul DeJong -> C:\\Users\\User\\Desktop\\球員資料\\players\\paul-dejong_18015_standard.csv\n",
      "[218/232] OK：Jake Bauers -> C:\\Users\\User\\Desktop\\球員資料\\players\\jake-bauers_15194_standard.csv\n",
      "[219/232] OK：Patrick Wisdom -> C:\\Users\\User\\Desktop\\球員資料\\players\\patrick-wisdom_13602_standard.csv\n",
      "[220/232] OK：Dylan Moore -> C:\\Users\\User\\Desktop\\球員資料\\players\\dylan-moore_18042_standard.csv\n",
      "[221/232] OK：Jose Siri -> C:\\Users\\User\\Desktop\\球員資料\\players\\jose-siri_17452_standard.csv\n",
      "[222/232] OK：Gary Sánchez -> C:\\Users\\User\\Desktop\\球員資料\\players\\gary-sanchez_11442_standard.csv\n",
      "[223/232] OK：Bo Naylor -> C:\\Users\\User\\Desktop\\球員資料\\players\\bo-naylor_21865_standard.csv\n",
      "[224/232] OK：Miguel Vargas -> C:\\Users\\User\\Desktop\\球員資料\\players\\miguel-vargas_20178_standard.csv\n",
      "[225/232] OK：Michael Toglia -> C:\\Users\\User\\Desktop\\球員資料\\players\\michael-toglia_25845_standard.csv\n",
      "[226/232] OK：Rougned Odor -> C:\\Users\\User\\Desktop\\球員資料\\players\\rougned-odor_12282_standard.csv\n",
      "[227/232] OK：Jack Suwinski -> C:\\Users\\User\\Desktop\\球員資料\\players\\jack-suwinski_22244_standard.csv\n",
      "[228/232] OK：Jackie Bradley Jr. -> C:\\Users\\User\\Desktop\\球員資料\\players\\jackie-bradley-jr_12984_standard.csv\n",
      "[229/232] OK：Taylor Walls -> C:\\Users\\User\\Desktop\\球員資料\\players\\taylor-walls_22458_standard.csv\n",
      "[230/232] OK：Martín Maldonado -> C:\\Users\\User\\Desktop\\球員資料\\players\\martin-maldonado_6887_standard.csv\n",
      "[231/232] OK：Joey Gallo -> C:\\Users\\User\\Desktop\\球員資料\\players\\joey-gallo_14128_standard.csv\n",
      "[232/232] OK：Austin Hedges -> C:\\Users\\User\\Desktop\\球員資料\\players\\austin-hedges_12976_standard.csv\n",
      "完成。輸出目錄：C:\\Users\\User\\Desktop\\球員資料\\players，共輸出 351 個檔案\n"
     ]
    }
   ],
   "source": [
    "import re, csv, os, time\n",
    "from urllib.parse import urljoin\n",
    "from pathlib import Path\n",
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "\n",
    "\n",
    "URL_TPL = (\"https://www.fangraphs.com/leaders/major-league?\"\n",
    "           \"pos=all&stats=bat&lg=all&qual=y&type=0&ind=0&rost=0&age=0&filter=&players=0\"\n",
    "           \"&pageitems=30&startdate=&enddate=&team=0&month=0&season1=2020&season=2025&pagenum={i}&csv\")\n",
    "\n",
    "BASE = \"https://www.fangraphs.com\"\n",
    "PAT  = re.compile(r\"/players/(.*?)/stats\\?\")   # 取 /players/ 和 /stats? 中間字串\n",
    "\n",
    "\n",
    "OUT_DIR = r\"C:\\Users\\User\\Desktop\\球員資料\\players\"\n",
    "os.makedirs(OUT_DIR, exist_ok=True)\n",
    "\n",
    "opts = Options()\n",
    "opts.add_argument(\"--start-maximized\")\n",
    "opts.add_argument(\"--disable-blink-features=AutomationControlled\")\n",
    "driver = webdriver.Chrome(options=opts)\n",
    "wait = WebDriverWait(driver, 20)\n",
    "\n",
    "all_rows = []   \n",
    "\n",
    "def scrape_one_player(player_url: str):\n",
    "    \"\"\"回傳二維陣列 rows（含表頭）；抓不到回傳 None。\"\"\"\n",
    "    driver.get(player_url)\n",
    "\n",
    "    try:\n",
    "        tab = wait.until(EC.element_to_be_clickable(\n",
    "            (By.XPATH, \"//button[normalize-space()='MLB Regular Season'] | //a[normalize-space()='MLB Regular Season']\")))\n",
    "        tab.click()\n",
    "        time.sleep(0.5)\n",
    "    except Exception:\n",
    "        pass\n",
    "\n",
    "    container = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"#standard.player-page-table\")))\n",
    "    driver.execute_script(\"arguments[0].scrollIntoView({block:'center'});\", container)\n",
    "    time.sleep(0.2)\n",
    "\n",
    "    try:\n",
    "        table = container.find_element(By.CSS_SELECTOR, \"table\")\n",
    "        trs = table.find_elements(By.CSS_SELECTOR, \"tr\")\n",
    "        data = []\n",
    "        for tr in trs:\n",
    "            cells = tr.find_elements(By.CSS_SELECTOR, \"th,td\")\n",
    "            data.append([c.text.strip() for c in cells])\n",
    "        if len(data) >= 2 and any(x.strip() for x in data[0]):\n",
    "            return data\n",
    "    except Exception:\n",
    "        pass\n",
    "\n",
    "    text = container.text or \"\"\n",
    "    lines = [ln for ln in text.splitlines() if ln.count(\"\\t\") >= 5]\n",
    "\n",
    "    header_idx = None\n",
    "    for i, ln in enumerate(lines):\n",
    "        if \"\\tG\\t\" in ln and \"\\tAB\\t\" in ln and \"\\tPA\\t\" in ln:\n",
    "            header_idx = i\n",
    "            break\n",
    "    if header_idx is None:\n",
    "        return None\n",
    "\n",
    "    header = lines[header_idx].split(\"\\t\")\n",
    "    ncol = len(header)\n",
    "    body = []\n",
    "    for ln in lines[header_idx+1:]:\n",
    "        if ln.startswith(\"Season\\tTeam\\t\") and \"\\tG\\t\" in ln:\n",
    "            break\n",
    "        parts = ln.split(\"\\t\")\n",
    "        if len(parts) >= ncol:\n",
    "            body.append(parts[:ncol])\n",
    "\n",
    "    if not body:\n",
    "        return None\n",
    "    return [header] + body\n",
    "\n",
    "try:\n",
    "    for i in range(1, 14): \n",
    "        url = URL_TPL.format(i=i)\n",
    "        driver.get(url)\n",
    "\n",
    "        wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"table thead\")))\n",
    "        wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"table tbody\")))\n",
    "\n",
    "        links = driver.find_elements(By.CSS_SELECTOR, \"table tbody tr td[data-col-id='Name'] a\")\n",
    "        for a in links:\n",
    "            name = a.text.strip()\n",
    "            href_raw = a.get_dom_attribute(\"href\") or \"\"        \n",
    "            href_abs = a.get_attribute(\"href\") or urljoin(BASE, href_raw)  \n",
    "\n",
    "            m = PAT.search(href_raw or href_abs)\n",
    "            if not m:\n",
    "                continue\n",
    "            mid = m.group(1)               \n",
    "            parts = mid.split(\"/\")\n",
    "            slug = parts[0] if parts else \"\"\n",
    "            pid  = parts[1] if len(parts) > 1 else \"\"\n",
    "\n",
    "            all_rows.append([i, name, slug, pid, mid, href_abs])\n",
    "\n",
    "        time.sleep(0.4) \n",
    "\n",
    "    seen = set()\n",
    "    players = []\n",
    "    for page, name, slug, pid, mid, url in all_rows:\n",
    "        if url in seen:\n",
    "            continue\n",
    "        seen.add(url)\n",
    "        players.append({\"page\": page, \"name\": name, \"slug\": slug, \"pid\": pid, \"mid\": mid, \"url\": url})\n",
    "\n",
    "    for idx, p in enumerate(players, 1):\n",
    "        name, slug, pid, url = p[\"name\"], p[\"slug\"], p[\"pid\"], p[\"url\"]\n",
    "\n",
    "        safe_slug = slug or re.sub(r\"[^\\w\\-]+\", \"-\", (name.strip().lower().replace(\" \", \"-\") or \"player\"))\n",
    "        safe_pid  = pid or \"NA\"\n",
    "        out_path  = Path(OUT_DIR) / f\"{safe_slug}_{safe_pid}_standard.csv\"\n",
    "\n",
    "        try:\n",
    "            data = scrape_one_player(url)\n",
    "            if not data:\n",
    "                print(f\"[{idx}/{len(players)}] 失敗：{name} -> 無法擷取表格\")\n",
    "                continue\n",
    "\n",
    "            with open(out_path, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "                csv.writer(f).writerows(data)\n",
    "\n",
    "            print(f\"[{idx}/{len(players)}] OK：{name} -> {out_path}\")\n",
    "        except Exception as e:\n",
    "            print(f\"[{idx}/{len(players)}] 例外：{name} -> {e}\")\n",
    "\n",
    "        time.sleep(0.4)\n",
    "\n",
    "finally:\n",
    "    driver.quit()\n",
    "\n",
    "print(f\"完成。輸出目錄：{OUT_DIR}，共輸出 {len(os.listdir(OUT_DIR))} 個檔案\")\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "21a90190",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "[debug] rows detected: 133\n",
      "OK: 133 rows -> C:\\Users\\User\\Desktop\\spotrac_free_agents_full_2020.csv\n"
     ]
    }
   ],
   "source": [
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "import time, csv, os\n",
    "\n",
    "URL = \"https://www.spotrac.com/mlb/free-agents/_/year/2020/level/mlb\"\n",
    "\n",
    "opts = Options()\n",
    "opts.add_argument(\"--start-maximized\")\n",
    "drv = webdriver.Chrome(options=opts)\n",
    "wait = WebDriverWait(drv, 30)\n",
    "\n",
    "def close_banners(drv):\n",
    "    # OneTrust cookie\n",
    "    for sel in [\"#onetrust-accept-btn-handler\", \"button#truste-consent-button\",\n",
    "                \"button[aria-label='Accept all']\",\n",
    "                \"button:contains('Accept')\"]:\n",
    "        try:\n",
    "            btn = drv.find_element(By.CSS_SELECTOR, sel)\n",
    "            if btn.is_displayed():\n",
    "                btn.click()\n",
    "                time.sleep(0.3)\n",
    "        except Exception:\n",
    "            pass\n",
    "    # 其他可能彈窗（登入/升級提示）\n",
    "    for sel in [\".close\", \".modal .close\", \"button[aria-label='Close']\"]:\n",
    "        try:\n",
    "            btn = drv.find_element(By.CSS_SELECTOR, sel)\n",
    "            if btn.is_displayed():\n",
    "                btn.click()\n",
    "                time.sleep(0.3)\n",
    "        except Exception:\n",
    "            pass\n",
    "\n",
    "def find_table(drv):\n",
    "    # 多組選擇器，依序嘗試\n",
    "    selectors = [\n",
    "        \"div.dt-scroll-body table[id^='DataTables_Table_']\",\n",
    "        \"div.dt-scroll-body table.table.dataTable\",\n",
    "        \"table[id^='DataTables_Table_']\",\n",
    "        \"table.table.dataTable\"\n",
    "    ]\n",
    "    for css in selectors:\n",
    "        try:\n",
    "            el = drv.find_element(By.CSS_SELECTOR, css)\n",
    "            if el:\n",
    "                return el\n",
    "        except Exception:\n",
    "            pass\n",
    "    return None\n",
    "\n",
    "def switch_iframe_and_find(drv):\n",
    "    # 嘗試在各個 iframe 中尋找表格\n",
    "    iframes = drv.find_elements(By.TAG_NAME, \"iframe\")\n",
    "    print(f\"[debug] iframes: {len(iframes)}\")\n",
    "    cur = drv.current_window_handle\n",
    "    for idx, fr in enumerate(iframes):\n",
    "        try:\n",
    "            drv.switch_to.frame(fr)\n",
    "            tbl = find_table(drv)\n",
    "            if tbl:\n",
    "                print(f\"[debug] table found in iframe #{idx}\")\n",
    "                return tbl, True\n",
    "            drv.switch_to.default_content()\n",
    "        except Exception:\n",
    "            try:\n",
    "                drv.switch_to.default_content()\n",
    "            except Exception:\n",
    "                pass\n",
    "    # 回到主文件\n",
    "    try:\n",
    "        drv.switch_to.default_content()\n",
    "    except Exception:\n",
    "        pass\n",
    "    return None, False\n",
    "\n",
    "def ensure_table(drv, wait, scroll=True):\n",
    "    # 關彈窗\n",
    "    close_banners(drv)\n",
    "    # 先在主文檔找\n",
    "    for _ in range(2):\n",
    "        tbl = find_table(drv)\n",
    "        if tbl:\n",
    "            break\n",
    "        time.sleep(0.5)\n",
    "    # 找不到就查 iframe\n",
    "    if not tbl:\n",
    "        tbl, in_iframe = switch_iframe_and_find(drv)\n",
    "    else:\n",
    "        in_iframe = False\n",
    "\n",
    "    if not tbl:\n",
    "        # 最後再等一次，讓 DataTables 完成初始化\n",
    "        try:\n",
    "            tbl = wait.until(EC.presence_of_element_located(\n",
    "                (By.CSS_SELECTOR, \"div.dt-scroll-body table[id^='DataTables_Table_'],\"\n",
    "                                   \"div.dt-scroll-body table.table.dataTable,\"\n",
    "                                   \"table[id^='DataTables_Table_'],\"\n",
    "                                   \"table.table.dataTable\")))\n",
    "        except Exception:\n",
    "            raise TimeoutError(\"找不到 DataTables 表格\")\n",
    "\n",
    "    # 滾動容器確保列渲染完全\n",
    "    if scroll:\n",
    "        try:\n",
    "            body = drv.find_element(By.CSS_SELECTOR, \"div.dt-scroll-body\")\n",
    "        except Exception:\n",
    "            body = None\n",
    "        if body:\n",
    "            last = -1\n",
    "            for _ in range(120):\n",
    "                drv.execute_script(\"arguments[0].scrollTop = arguments[0].scrollHeight;\", body)\n",
    "                time.sleep(0.2)\n",
    "                cur = drv.execute_script(\"return arguments[0].scrollTop;\", body)\n",
    "                if cur == last:\n",
    "                    break\n",
    "                last = cur\n",
    "        else:\n",
    "            # 沒有滾動容器就整頁下拉\n",
    "            h_last = 0\n",
    "            for _ in range(60):\n",
    "                drv.execute_script(\"window.scrollTo(0, document.body.scrollHeight);\")\n",
    "                time.sleep(0.2)\n",
    "                h_cur = drv.execute_script(\"return document.body.scrollHeight;\")\n",
    "                if h_cur == h_last:\n",
    "                    break\n",
    "                h_last = h_cur\n",
    "\n",
    "    return tbl\n",
    "\n",
    "try:\n",
    "    drv.get(URL)\n",
    "    table = ensure_table(drv, wait, scroll=True)\n",
    "\n",
    "    # 讀表頭\n",
    "    headers = []\n",
    "    for th in table.find_elements(By.CSS_SELECTOR, \"thead th\"):\n",
    "        txt = (th.get_attribute(\"innerText\") or th.text or \"\").strip()\n",
    "        headers.append(\" \".join(txt.split()))\n",
    "    if not headers:\n",
    "        # 有些 DataTables 把表頭放在多層 <tr>\n",
    "        ths = table.find_elements(By.CSS_SELECTOR, \"thead tr:last-child th\")\n",
    "        headers = [\" \".join((th.get_attribute(\"innerText\") or th.text or \"\").split()) for th in ths]\n",
    "\n",
    "    # PLAYER 欄索引\n",
    "    player_idx = next((i for i,h in enumerate(headers) if h.upper().startswith(\"PLAYER\")), None)\n",
    "\n",
    "    # 讀資料列\n",
    "    rows_out = []\n",
    "    trs = table.find_elements(By.CSS_SELECTOR, \"tbody tr\")\n",
    "    print(f\"[debug] rows detected: {len(trs)}\")\n",
    "    for tr in trs:\n",
    "        tds = tr.find_elements(By.CSS_SELECTOR, \"td\")\n",
    "        if not tds:\n",
    "            continue\n",
    "        row = []\n",
    "        for td in tds:\n",
    "            val = (td.get_attribute(\"innerText\") or td.text or \"\").strip()\n",
    "            row.append(\" \".join(val.split()))\n",
    "        # 長度對齊\n",
    "        if len(row) < len(headers):\n",
    "            row += [\"\"]*(len(headers)-len(row))\n",
    "        elif len(row) > len(headers):\n",
    "            row = row[:len(headers)]\n",
    "        # 取球員 URL\n",
    "        player_url = \"\"\n",
    "        if player_idx is not None and player_idx < len(tds):\n",
    "            try:\n",
    "                a = tds[player_idx].find_element(By.CSS_SELECTOR, \"a[href]\")\n",
    "                player_url = a.get_attribute(\"href\") or \"\"\n",
    "            except Exception:\n",
    "                pass\n",
    "        row.append(player_url)\n",
    "        rows_out.append(row)\n",
    "\n",
    "    # 輸出\n",
    "    out_csv = os.path.join(os.path.expanduser(\"~\"), \"Desktop\", \"spotrac_free_agents_full_2020.csv\")\n",
    "    with open(out_csv, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "        w = csv.writer(f)\n",
    "        w.writerow(headers + [\"PlayerURL\"])\n",
    "        w.writerows(rows_out)\n",
    "    print(f\"OK: {len(rows_out)} rows -> {out_csv}\")\n",
    "\n",
    "finally:\n",
    "    try: drv.quit()\n",
    "    except: pass\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "9d826a52",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "OK: year=2021, rows=160 -> C:\\Users\\User\\Desktop\\spotrac_free_agents_full_2021.csv\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "'C:\\\\Users\\\\User\\\\Desktop\\\\spotrac_free_agents_full_2021.csv'"
      ]
     },
     "execution_count": 11,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "import time, os, csv\n",
    "\n",
    "def scrape_spotrac(year=2021, level=\"mlb\", out_dir=None, timeout=30):\n",
    "    URL = f\"https://www.spotrac.com/{level}/free-agents/_/year/{year}/level/{level}\"\n",
    "\n",
    "    opts = Options()\n",
    "    opts.add_argument(\"--start-maximized\")\n",
    "    drv = webdriver.Chrome(options=opts)\n",
    "    wait = WebDriverWait(drv, timeout)\n",
    "\n",
    "    def close_banners(drv):\n",
    "        # 常見 Cookie/促銷彈窗\n",
    "        for sel in [\n",
    "            \"#onetrust-accept-btn-handler\",\n",
    "            \"button#truste-consent-button\",\n",
    "            \"button[aria-label='Accept all']\",\n",
    "            \"button[aria-label='Close']\",\n",
    "            \".modal .close\",\n",
    "            \".close\"\n",
    "        ]:\n",
    "            try:\n",
    "                el = drv.find_element(By.CSS_SELECTOR, sel)\n",
    "                if el.is_displayed():\n",
    "                    el.click()\n",
    "                    time.sleep(0.3)\n",
    "            except Exception:\n",
    "                pass\n",
    "\n",
    "    def find_table(drv):\n",
    "        for css in [\n",
    "            \"div.dt-scroll-body table[id^='DataTables_Table_']\",\n",
    "            \"div.dt-scroll-body table.table.dataTable\",\n",
    "            \"table[id^='DataTables_Table_']\",\n",
    "            \"table.table.dataTable\"\n",
    "        ]:\n",
    "            try:\n",
    "                el = drv.find_element(By.CSS_SELECTOR, css)\n",
    "                if el:\n",
    "                    return el\n",
    "            except Exception:\n",
    "                pass\n",
    "        return None\n",
    "\n",
    "    def switch_iframe_and_find(drv):\n",
    "        iframes = drv.find_elements(By.TAG_NAME, \"iframe\")\n",
    "        for fr in iframes:\n",
    "            try:\n",
    "                drv.switch_to.frame(fr)\n",
    "                el = find_table(drv)\n",
    "                if el:\n",
    "                    return el, True\n",
    "                drv.switch_to.default_content()\n",
    "            except Exception:\n",
    "                try:\n",
    "                    drv.switch_to.default_content()\n",
    "                except Exception:\n",
    "                    pass\n",
    "        try:\n",
    "            drv.switch_to.default_content()\n",
    "        except Exception:\n",
    "            pass\n",
    "        return None, False\n",
    "\n",
    "    def ensure_table(drv, wait, scroll=True):\n",
    "        close_banners(drv)\n",
    "        tbl = find_table(drv)\n",
    "        if not tbl:\n",
    "            tbl, _ = switch_iframe_and_find(drv)\n",
    "        if not tbl:\n",
    "            tbl = wait.until(EC.presence_of_element_located((\n",
    "                By.CSS_SELECTOR,\n",
    "                \"div.dt-scroll-body table[id^='DataTables_Table_'],\"\n",
    "                \"div.dt-scroll-body table.table.dataTable,\"\n",
    "                \"table[id^='DataTables_Table_'],\"\n",
    "                \"table.table.dataTable\"\n",
    "            )))\n",
    "        # 滾動渲染完整\n",
    "        if scroll:\n",
    "            try:\n",
    "                body = drv.find_element(By.CSS_SELECTOR, \"div.dt-scroll-body\")\n",
    "            except Exception:\n",
    "                body = None\n",
    "            if body:\n",
    "                last = -1\n",
    "                for _ in range(160):\n",
    "                    drv.execute_script(\"arguments[0].scrollTop = arguments[0].scrollHeight;\", body)\n",
    "                    time.sleep(0.2)\n",
    "                    cur = drv.execute_script(\"return arguments[0].scrollTop;\", body)\n",
    "                    if cur == last:\n",
    "                        break\n",
    "                    last = cur\n",
    "            else:\n",
    "                h_last = 0\n",
    "                for _ in range(80):\n",
    "                    drv.execute_script(\"window.scrollTo(0, document.body.scrollHeight);\")\n",
    "                    time.sleep(0.2)\n",
    "                    h_cur = drv.execute_script(\"return document.body.scrollHeight;\")\n",
    "                    if h_cur == h_last:\n",
    "                        break\n",
    "                    h_last = h_cur\n",
    "        return tbl\n",
    "\n",
    "    try:\n",
    "        drv.get(URL)\n",
    "        table = ensure_table(drv, wait, scroll=True)\n",
    "\n",
    "        # 表頭\n",
    "        headers = []\n",
    "        ths = table.find_elements(By.CSS_SELECTOR, \"thead tr:last-child th\")\n",
    "        if not ths:\n",
    "            ths = table.find_elements(By.CSS_SELECTOR, \"thead th\")\n",
    "        for th in ths:\n",
    "            txt = (th.get_attribute(\"innerText\") or th.text or \"\").strip()\n",
    "            headers.append(\" \".join(txt.split()))\n",
    "\n",
    "        # 嘗試找 PLAYER 欄位索引（用於取超連結）\n",
    "        player_idx = next((i for i, h in enumerate(headers) if h.upper().startswith(\"PLAYER\")), None)\n",
    "\n",
    "        # 資料列\n",
    "        rows_out = []\n",
    "        trs = table.find_elements(By.CSS_SELECTOR, \"tbody tr\")\n",
    "        for tr in trs:\n",
    "            tds = tr.find_elements(By.CSS_SELECTOR, \"td\")\n",
    "            if not tds:\n",
    "                continue\n",
    "            row = []\n",
    "            for td in tds:\n",
    "                val = (td.get_attribute(\"innerText\") or td.text or \"\").strip()\n",
    "                row.append(\" \".join(val.split()))\n",
    "            # 對齊欄數\n",
    "            if len(row) < len(headers):\n",
    "                row += [\"\"] * (len(headers) - len(row))\n",
    "            elif len(row) > len(headers):\n",
    "                row = row[:len(headers)]\n",
    "            # 取玩家連結\n",
    "            player_url = \"\"\n",
    "            if player_idx is not None and player_idx < len(tds):\n",
    "                try:\n",
    "                    a = tds[player_idx].find_element(By.CSS_SELECTOR, \"a[href]\")\n",
    "                    player_url = a.get_attribute(\"href\") or \"\"\n",
    "                except Exception:\n",
    "                    pass\n",
    "            row.append(player_url)\n",
    "            rows_out.append(row)\n",
    "\n",
    "        # 輸出\n",
    "        if out_dir is None:\n",
    "            out_dir = os.path.join(os.path.expanduser(\"~\"), \"Desktop\")\n",
    "        os.makedirs(out_dir, exist_ok=True)\n",
    "        out_csv = os.path.join(out_dir, f\"spotrac_free_agents_full_{year}.csv\")\n",
    "        with open(out_csv, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "            w = csv.writer(f)\n",
    "            w.writerow(headers + [\"PlayerURL\"])\n",
    "            w.writerows(rows_out)\n",
    "        print(f\"OK: year={year}, rows={len(rows_out)} -> {out_csv}\")\n",
    "        return out_csv\n",
    "    finally:\n",
    "        try:\n",
    "            drv.quit()\n",
    "        except:\n",
    "            pass\n",
    "\n",
    "# 單年\n",
    "scrape_spotrac(2021)\n",
    "\n",
    "# 多年批次（需要就開）\n",
    "# for yr in range(2020, 2026):\n",
    "#     scrape_spotrac(yr)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "5e67b992",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "OK: year=2022, rows=156 -> C:\\Users\\User\\Desktop\\spotrac_free_agents_signed_2022.csv\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "'C:\\\\Users\\\\User\\\\Desktop\\\\spotrac_free_agents_signed_2022.csv'"
      ]
     },
     "execution_count": 12,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "import time, os, csv\n",
    "\n",
    "def scrape_spotrac_signed(year=2022, level=\"mlb\", out_dir=None, timeout=30):\n",
    "    url = f\"https://www.spotrac.com/{level}/free-agents/signed/_/year/{year}/level/{level}\"\n",
    "\n",
    "    opts = Options()\n",
    "    opts.add_argument(\"--start-maximized\")\n",
    "    drv = webdriver.Chrome(options=opts)\n",
    "    wait = WebDriverWait(drv, timeout)\n",
    "\n",
    "    def close_banners():\n",
    "        for sel in [\n",
    "            \"#onetrust-accept-btn-handler\",\n",
    "            \"button#truste-consent-button\",\n",
    "            \"button[aria-label='Accept all']\",\n",
    "            \".modal .close\",\n",
    "            \"button.close\",\n",
    "            \".ot-pc-refuse-all-handler\",\n",
    "        ]:\n",
    "            try:\n",
    "                el = drv.find_element(By.CSS_SELECTOR, sel)\n",
    "                if el.is_displayed():\n",
    "                    el.click()\n",
    "                    time.sleep(0.3)\n",
    "            except Exception:\n",
    "                pass\n",
    "\n",
    "    def find_table():\n",
    "        for css in [\n",
    "            \"div.dt-scroll-body table[id^='DataTables_Table_']\",\n",
    "            \"div.dt-scroll-body table.table.dataTable\",\n",
    "            \"table[id^='DataTables_Table_']\",\n",
    "            \"table.table.dataTable\",\n",
    "        ]:\n",
    "            try:\n",
    "                el = drv.find_element(By.CSS_SELECTOR, css)\n",
    "                if el:\n",
    "                    return el\n",
    "            except Exception:\n",
    "                pass\n",
    "        return None\n",
    "\n",
    "    def ensure_table():\n",
    "        close_banners()\n",
    "        body = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"div.dt-scroll-body\")))\n",
    "        tbl = find_table()\n",
    "        if not tbl:\n",
    "            tbl = wait.until(EC.presence_of_element_located((\n",
    "                By.CSS_SELECTOR,\n",
    "                \"div.dt-scroll-body table[id^='DataTables_Table_'],\"\n",
    "                \"div.dt-scroll-body table.table.dataTable\"\n",
    "            )))\n",
    "        # 讓 DataTables 把所有列渲染出來\n",
    "        last = -1\n",
    "        for _ in range(200):\n",
    "            drv.execute_script(\"arguments[0].scrollTop = arguments[0].scrollHeight;\", body)\n",
    "            time.sleep(0.2)\n",
    "            cur = drv.execute_script(\"return arguments[0].scrollTop;\", body)\n",
    "            if cur == last:\n",
    "                break\n",
    "            last = cur\n",
    "        return tbl\n",
    "\n",
    "    try:\n",
    "        drv.get(url)\n",
    "        table = ensure_table()\n",
    "\n",
    "        # 表頭（取最後一層）\n",
    "        ths = table.find_elements(By.CSS_SELECTOR, \"thead tr:last-child th\")\n",
    "        if not ths:\n",
    "            ths = table.find_elements(By.CSS_SELECTOR, \"thead th\")\n",
    "        headers = [\" \".join((th.get_attribute(\"innerText\") or th.text or \"\").split()) for th in ths]\n",
    "\n",
    "        # 找 PLAYER 欄位索引\n",
    "        player_idx = next((i for i, h in enumerate(headers) if h.upper().startswith(\"PLAYER\")), None)\n",
    "\n",
    "        # 逐列擷取\n",
    "        rows_out = []\n",
    "        trs = table.find_elements(By.CSS_SELECTOR, \"tbody tr\")\n",
    "        for tr in trs:\n",
    "            tds = tr.find_elements(By.CSS_SELECTOR, \"td\")\n",
    "            if not tds:\n",
    "                continue\n",
    "            row = [\" \".join((td.get_attribute(\"innerText\") or td.text or \"\").split()) for td in tds]\n",
    "            # 對齊欄數\n",
    "            if len(row) < len(headers):\n",
    "                row += [\"\"] * (len(headers) - len(row))\n",
    "            elif len(row) > len(headers):\n",
    "                row = row[:len(headers)]\n",
    "            # PLAYER 超連結\n",
    "            player_url = \"\"\n",
    "            if player_idx is not None and player_idx < len(tds):\n",
    "                try:\n",
    "                    a = tds[player_idx].find_element(By.CSS_SELECTOR, \"a[href]\")\n",
    "                    player_url = a.get_attribute(\"href\") or \"\"\n",
    "                except Exception:\n",
    "                    pass\n",
    "            row.append(player_url)\n",
    "            rows_out.append(row)\n",
    "\n",
    "        # 輸出\n",
    "        if out_dir is None:\n",
    "            out_dir = os.path.join(os.path.expanduser(\"~\"), \"Desktop\")\n",
    "        os.makedirs(out_dir, exist_ok=True)\n",
    "        out_csv = os.path.join(out_dir, f\"spotrac_free_agents_signed_{year}.csv\")\n",
    "        with open(out_csv, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "            w = csv.writer(f)\n",
    "            w.writerow(headers + [\"PlayerURL\"])\n",
    "            w.writerows(rows_out)\n",
    "\n",
    "        print(f\"OK: year={year}, rows={len(rows_out)} -> {out_csv}\")\n",
    "        return out_csv\n",
    "    finally:\n",
    "        try:\n",
    "            drv.quit()\n",
    "        except:\n",
    "            pass\n",
    "\n",
    "# 範例：抓 2022 已簽約清單\n",
    "scrape_spotrac_signed(2022)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "72ab7744",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "OK year=2023, rows=152 -> C:\\Users\\User\\Desktop\\spotrac_free_agents_signed_2023.csv\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "'C:\\\\Users\\\\User\\\\Desktop\\\\spotrac_free_agents_signed_2023.csv'"
      ]
     },
     "execution_count": 13,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "import time, os, csv\n",
    "\n",
    "def scrape_spotrac_signed(year=2023, level=\"mlb\", out_dir=None, timeout=30):\n",
    "    url = f\"https://www.spotrac.com/{level}/free-agents/signed/_/year/{year}/level/{level}\"\n",
    "    opts = Options()\n",
    "    opts.add_argument(\"--start-maximized\")\n",
    "    drv = webdriver.Chrome(options=opts)\n",
    "    wait = WebDriverWait(drv, timeout)\n",
    "\n",
    "    def close_banners():\n",
    "        for sel in [\n",
    "            \"#onetrust-accept-btn-handler\",\n",
    "            \"button#truste-consent-button\",\n",
    "            \"button[aria-label='Accept all']\",\n",
    "            \".modal .close\", \"button.close\", \".ot-pc-refuse-all-handler\",\n",
    "        ]:\n",
    "            try:\n",
    "                el = drv.find_element(By.CSS_SELECTOR, sel)\n",
    "                if el.is_displayed():\n",
    "                    el.click(); time.sleep(0.2)\n",
    "            except: pass\n",
    "\n",
    "    def find_table():\n",
    "        for css in [\n",
    "            \"div.dt-scroll-body table[id^='DataTables_Table_']\",\n",
    "            \"div.dt-scroll-body table.table.dataTable\",\n",
    "            \"table[id^='DataTables_Table_']\",\n",
    "            \"table.table.dataTable\",\n",
    "        ]:\n",
    "            try:\n",
    "                el = drv.find_element(By.CSS_SELECTOR, css)\n",
    "                if el: return el\n",
    "            except: pass\n",
    "        return None\n",
    "\n",
    "    try:\n",
    "        drv.get(url)\n",
    "        close_banners()\n",
    "        body = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"div.dt-scroll-body\")))\n",
    "        table = find_table() or wait.until(EC.presence_of_element_located((\n",
    "            By.CSS_SELECTOR,\n",
    "            \"div.dt-scroll-body table[id^='DataTables_Table_'],div.dt-scroll-body table.table.dataTable\"\n",
    "        )))\n",
    "\n",
    "        # 讓 DataTables 完整渲染\n",
    "        last = -1\n",
    "        for _ in range(240):\n",
    "            drv.execute_script(\"arguments[0].scrollTop = arguments[0].scrollHeight;\", body)\n",
    "            time.sleep(0.15)\n",
    "            cur = drv.execute_script(\"return arguments[0].scrollTop;\", body)\n",
    "            if cur == last: break\n",
    "            last = cur\n",
    "\n",
    "        ths = table.find_elements(By.CSS_SELECTOR, \"thead tr:last-child th\") or table.find_elements(By.CSS_SELECTOR, \"thead th\")\n",
    "        headers = [\" \".join((th.get_attribute(\"innerText\") or th.text or \"\").split()) for th in ths]\n",
    "        player_idx = next((i for i,h in enumerate(headers) if h.upper().startswith(\"PLAYER\")), None)\n",
    "\n",
    "        out = []\n",
    "        for tr in table.find_elements(By.CSS_SELECTOR, \"tbody tr\"):\n",
    "            tds = tr.find_elements(By.CSS_SELECTOR, \"td\")\n",
    "            if not tds: continue\n",
    "            row = [\" \".join((td.get_attribute(\"innerText\") or td.text or \"\").split()) for td in tds]\n",
    "            if len(row) < len(headers): row += [\"\"]*(len(headers)-len(row))\n",
    "            if len(row) > len(headers): row = row[:len(headers)]\n",
    "            purl = \"\"\n",
    "            if player_idx is not None and player_idx < len(tds):\n",
    "                try:\n",
    "                    a = tds[player_idx].find_element(By.CSS_SELECTOR, \"a[href]\")\n",
    "                    purl = a.get_attribute(\"href\") or \"\"\n",
    "                except: pass\n",
    "            row.append(purl)\n",
    "            out.append(row)\n",
    "\n",
    "        if out_dir is None:\n",
    "            out_dir = os.path.join(os.path.expanduser(\"~\"), \"Desktop\")\n",
    "        os.makedirs(out_dir, exist_ok=True)\n",
    "        out_csv = os.path.join(out_dir, f\"spotrac_free_agents_signed_{year}.csv\")\n",
    "        with open(out_csv, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "            w = csv.writer(f); w.writerow(headers + [\"PlayerURL\"]); w.writerows(out)\n",
    "        print(f\"OK year={year}, rows={len(out)} -> {out_csv}\")\n",
    "        return out_csv\n",
    "    finally:\n",
    "        try: drv.quit()\n",
    "        except: pass\n",
    "\n",
    "# 例：抓 2023 已簽約\n",
    "scrape_spotrac_signed(2023)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "6911c4ac",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "OK year=2024 rows=163 -> C:\\Users\\User\\Desktop\\spotrac_free_agents_signed_2024.csv\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "'C:\\\\Users\\\\User\\\\Desktop\\\\spotrac_free_agents_signed_2024.csv'"
      ]
     },
     "execution_count": 14,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "import time, os, csv\n",
    "\n",
    "def scrape_spotrac_signed(year=2024, level=\"mlb\", out_dir=None, timeout=40):\n",
    "    url = f\"https://www.spotrac.com/{level}/free-agents/signed/_/year/{year}/level/{level}\"\n",
    "    opts = Options()\n",
    "    opts.add_argument(\"--start-maximized\")\n",
    "    # 視需要加上 headless：\n",
    "    # opts.add_argument(\"--headless=new\")\n",
    "    drv = webdriver.Chrome(options=opts)\n",
    "    wait = WebDriverWait(drv, timeout)\n",
    "\n",
    "    def click_if_present(css):\n",
    "        try:\n",
    "            el = drv.find_element(By.CSS_SELECTOR, css)\n",
    "            if el.is_displayed(): el.click(); time.sleep(0.2)\n",
    "        except: pass\n",
    "\n",
    "    def close_banners():\n",
    "        for sel in [\n",
    "            \"#onetrust-accept-btn-handler\",\n",
    "            \"button#truste-consent-button\",\n",
    "            \"button[aria-label='Accept all']\",\n",
    "            \".modal .close\", \"button.close\", \".ot-pc-refuse-all-handler\",\n",
    "        ]:\n",
    "            click_if_present(sel)\n",
    "\n",
    "    def find_table_in_body():\n",
    "        # 鎖定可捲動的主體表，不抓左右固定欄 clone\n",
    "        for css in [\n",
    "            \"div.dt-scroll-body table[id^='DataTables_Table_']\",\n",
    "            \"div.dt-scroll-body table.table.dataTable\",\n",
    "        ]:\n",
    "            try:\n",
    "                t = drv.find_element(By.CSS_SELECTOR, css)\n",
    "                if t: return t\n",
    "            except: pass\n",
    "        return None\n",
    "\n",
    "    try:\n",
    "        drv.get(url)\n",
    "        close_banners()\n",
    "\n",
    "        body = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"div.dt-scroll-body\")))\n",
    "        # 等 tbody 出現至少一列\n",
    "        wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"div.dt-scroll-body table tbody tr\")))\n",
    "        table = find_table_in_body()\n",
    "        if table is None:\n",
    "            table = wait.until(EC.presence_of_element_located((\n",
    "                By.CSS_SELECTOR, \"div.dt-scroll-body table[id^='DataTables_Table_'],div.dt-scroll-body table.table.dataTable\"\n",
    "            )))\n",
    "\n",
    "        # 讓 DataTables 全部渲染：多次捲動到底，直到不再增加高度\n",
    "        last_h = -1\n",
    "        stable = 0\n",
    "        for _ in range(400):\n",
    "            drv.execute_script(\"arguments[0].scrollTop = arguments[0].scrollHeight;\", body)\n",
    "            time.sleep(0.12)\n",
    "            h = drv.execute_script(\"return arguments[0].scrollTop;\", body)\n",
    "            if h == last_h:\n",
    "                stable += 1\n",
    "                if stable >= 10: break\n",
    "            else:\n",
    "                stable = 0\n",
    "                last_h = h\n",
    "\n",
    "        # 取表頭（最下層那列 th）\n",
    "        ths = table.find_elements(By.CSS_SELECTOR, \"thead tr:last-child th\")\n",
    "        if not ths:\n",
    "            ths = table.find_elements(By.CSS_SELECTOR, \"thead th\")\n",
    "        headers = [\" \".join((th.get_attribute(\"innerText\") or th.text or \"\").split()) for th in ths]\n",
    "        if not headers:\n",
    "            raise RuntimeError(\"表頭未載入\")\n",
    "\n",
    "        # 找 PLAYER 欄位索引，用來取 a.href\n",
    "        player_idx = next((i for i,h in enumerate(headers) if h.strip().upper().startswith(\"PLAYER\")), None)\n",
    "\n",
    "        rows_out = []\n",
    "        for tr in table.find_elements(By.CSS_SELECTOR, \"tbody tr\"):\n",
    "            tds = tr.find_elements(By.CSS_SELECTOR, \"td\")\n",
    "            if not tds: continue\n",
    "            row = [\" \".join((td.get_attribute(\"innerText\") or td.text or \"\").split()) for td in tds]\n",
    "            # 對齊欄數\n",
    "            if len(row) < len(headers): row += [\"\"]*(len(headers)-len(row))\n",
    "            if len(row) > len(headers): row = row[:len(headers)]\n",
    "            # 取 PLAYER 超連結\n",
    "            player_url = \"\"\n",
    "            if player_idx is not None and player_idx < len(tds):\n",
    "                try:\n",
    "                    a = tds[player_idx].find_element(By.CSS_SELECTOR, \"a[href]\")\n",
    "                    player_url = a.get_attribute(\"href\") or \"\"\n",
    "                except: pass\n",
    "            row.append(player_url)\n",
    "            rows_out.append(row)\n",
    "\n",
    "        # 輸出\n",
    "        if out_dir is None:\n",
    "            out_dir = os.path.join(os.path.expanduser(\"~\"), \"Desktop\")\n",
    "        os.makedirs(out_dir, exist_ok=True)\n",
    "        out_csv = os.path.join(out_dir, f\"spotrac_free_agents_signed_{year}.csv\")\n",
    "        with open(out_csv, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "            w = csv.writer(f)\n",
    "            w.writerow(headers + [\"PlayerURL\"])\n",
    "            w.writerows(rows_out)\n",
    "\n",
    "        print(f\"OK year={year} rows={len(rows_out)} -> {out_csv}\")\n",
    "        return out_csv\n",
    "\n",
    "    finally:\n",
    "        try: drv.quit()\n",
    "        except: pass\n",
    "\n",
    "# 執行：抓 2024 已簽約整表\n",
    "scrape_spotrac_signed(2024)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "0914305f",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "OK year=2025 rows=183 -> C:\\Users\\User\\Desktop\\spotrac_free_agents_signed_2025.csv\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "'C:\\\\Users\\\\User\\\\Desktop\\\\spotrac_free_agents_signed_2025.csv'"
      ]
     },
     "execution_count": 15,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "import time, os, csv\n",
    "\n",
    "def scrape_spotrac_signed(year=2025, level=\"mlb\", out_dir=None, timeout=60):\n",
    "    url = f\"https://www.spotrac.com/{level}/free-agents/signed/_/year/{year}/level/{level}\"\n",
    "    opts = Options()\n",
    "    opts.add_argument(\"--start-maximized\")\n",
    "    # 視需要無頭：\n",
    "    # opts.add_argument(\"--headless=new\")\n",
    "    drv = webdriver.Chrome(options=opts)\n",
    "    wait = WebDriverWait(drv, timeout)\n",
    "\n",
    "    def click_if_present(css):\n",
    "        try:\n",
    "            el = drv.find_element(By.CSS_SELECTOR, css)\n",
    "            if el.is_displayed():\n",
    "                el.click()\n",
    "                time.sleep(0.2)\n",
    "        except:\n",
    "            pass\n",
    "\n",
    "    def close_banners():\n",
    "        for sel in [\n",
    "            \"#onetrust-accept-btn-handler\",\n",
    "            \"button#truste-consent-button\",\n",
    "            \"button[aria-label='Accept all']\",\n",
    "            \".modal .close\", \"button.close\", \".ot-pc-refuse-all-handler\",\n",
    "        ]:\n",
    "            click_if_present(sel)\n",
    "\n",
    "    def find_table_in_body():\n",
    "        for css in [\n",
    "            \"div.dt-scroll-body table[id^='DataTables_Table_']\",\n",
    "            \"div.dt-scroll-body table.table.dataTable\",\n",
    "        ]:\n",
    "            try:\n",
    "                t = drv.find_element(By.CSS_SELECTOR, css)\n",
    "                if t: return t\n",
    "            except:\n",
    "                pass\n",
    "        return None\n",
    "\n",
    "    try:\n",
    "        drv.get(url)\n",
    "        close_banners()\n",
    "\n",
    "        body = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"div.dt-scroll-body\")))\n",
    "        wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"div.dt-scroll-body table tbody tr\")))\n",
    "        table = find_table_in_body()\n",
    "        if table is None:\n",
    "            table = wait.until(EC.presence_of_element_located((\n",
    "                By.CSS_SELECTOR, \"div.dt-scroll-body table[id^='DataTables_Table_'],div.dt-scroll-body table.table.dataTable\"\n",
    "            )))\n",
    "\n",
    "        # 讓全部列渲染：同時看 scrollTop 與 當前列數，直到兩者都穩定\n",
    "        last_scroll = -1\n",
    "        last_rows = -1\n",
    "        stable_hits = 0\n",
    "        for _ in range(800):  # 2025 列較多，放寬迭代上限\n",
    "            drv.execute_script(\"arguments[0].scrollTop = arguments[0].scrollHeight;\", body)\n",
    "            time.sleep(0.12)\n",
    "            cur_scroll = drv.execute_script(\"return arguments[0].scrollTop;\", body)\n",
    "            cur_rows = len(table.find_elements(By.CSS_SELECTOR, \"tbody tr\"))\n",
    "            if cur_scroll == last_scroll and cur_rows == last_rows:\n",
    "                stable_hits += 1\n",
    "                if stable_hits >= 10:\n",
    "                    break\n",
    "            else:\n",
    "                stable_hits = 0\n",
    "                last_scroll, last_rows = cur_scroll, cur_rows\n",
    "\n",
    "        # 表頭\n",
    "        ths = table.find_elements(By.CSS_SELECTOR, \"thead tr:last-child th\")\n",
    "        if not ths:\n",
    "            ths = table.find_elements(By.CSS_SELECTOR, \"thead th\")\n",
    "        headers = [\" \".join((th.get_attribute(\"innerText\") or th.text or \"\").split()) for th in ths]\n",
    "        if not headers:\n",
    "            raise RuntimeError(\"表頭未載入\")\n",
    "\n",
    "        # PLAYER 欄位索引\n",
    "        player_idx = next((i for i,h in enumerate(headers) if h.strip().upper().startswith(\"PLAYER\")), None)\n",
    "\n",
    "        # 逐列擷取\n",
    "        rows_out = []\n",
    "        for tr in table.find_elements(By.CSS_SELECTOR, \"tbody tr\"):\n",
    "            tds = tr.find_elements(By.CSS_SELECTOR, \"td\")\n",
    "            if not tds: continue\n",
    "            row = [\" \".join((td.get_attribute(\"innerText\") or td.text or \"\").split()) for td in tds]\n",
    "            if len(row) < len(headers): row += [\"\"]*(len(headers)-len(row))\n",
    "            if len(row) > len(headers): row = row[:len(headers)]\n",
    "            player_url = \"\"\n",
    "            if player_idx is not None and player_idx < len(tds):\n",
    "                try:\n",
    "                    a = tds[player_idx].find_element(By.CSS_SELECTOR, \"a[href]\")\n",
    "                    player_url = a.get_attribute(\"href\") or \"\"\n",
    "                except:\n",
    "                    pass\n",
    "            row.append(player_url)\n",
    "            rows_out.append(row)\n",
    "\n",
    "        # 輸出\n",
    "        if out_dir is None:\n",
    "            out_dir = os.path.join(os.path.expanduser(\"~\"), \"Desktop\")\n",
    "        os.makedirs(out_dir, exist_ok=True)\n",
    "        out_csv = os.path.join(out_dir, f\"spotrac_free_agents_signed_{year}.csv\")\n",
    "        with open(out_csv, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "            w = csv.writer(f)\n",
    "            w.writerow(headers + [\"PlayerURL\"])\n",
    "            w.writerows(rows_out)\n",
    "\n",
    "        print(f\"OK year={year} rows={len(rows_out)} -> {out_csv}\")\n",
    "        return out_csv\n",
    "\n",
    "    finally:\n",
    "        try: drv.quit()\n",
    "        except: pass\n",
    "\n",
    "# 執行：抓 2025 已簽約整表\n",
    "scrape_spotrac_signed(2025)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "0b081f44",
   "metadata": {},
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "OK year=2025 rows=67 -> C:\\Users\\User\\Desktop\\spotrac_free_agents_available_2025.csv\n"
     ]
    },
    {
     "data": {
      "text/plain": [
       "'C:\\\\Users\\\\User\\\\Desktop\\\\spotrac_free_agents_available_2025.csv'"
      ]
     },
     "execution_count": 16,
     "metadata": {},
     "output_type": "execute_result"
    }
   ],
   "source": [
    "from selenium import webdriver\n",
    "from selenium.webdriver.common.by import By\n",
    "from selenium.webdriver.chrome.options import Options\n",
    "from selenium.webdriver.support.ui import WebDriverWait\n",
    "from selenium.webdriver.support import expected_conditions as EC\n",
    "import time, os, csv\n",
    "\n",
    "def scrape_spotrac_available(year=2025, level=\"mlb\", out_dir=None, timeout=60):\n",
    "    url = f\"https://www.spotrac.com/{level}/free-agents/available/_/year/{year}/level/{level}\"\n",
    "    opts = Options()\n",
    "    opts.add_argument(\"--start-maximized\")\n",
    "    # 視需要無頭：\n",
    "    # opts.add_argument(\"--headless=new\")\n",
    "    drv = webdriver.Chrome(options=opts)\n",
    "    wait = WebDriverWait(drv, timeout)\n",
    "\n",
    "    def click_if_present(css):\n",
    "        try:\n",
    "            el = drv.find_element(By.CSS_SELECTOR, css)\n",
    "            if el.is_displayed(): \n",
    "                el.click()\n",
    "                time.sleep(0.25)\n",
    "        except:\n",
    "            pass\n",
    "\n",
    "    def close_banners():\n",
    "        for sel in [\n",
    "            \"#onetrust-accept-btn-handler\",          # Cookie\n",
    "            \"button#truste-consent-button\",\n",
    "            \"button[aria-label='Accept all']\",\n",
    "            \".ot-pc-refuse-all-handler\",\n",
    "            \".modal .close\", \"button.close\",\n",
    "        ]:\n",
    "            click_if_present(sel)\n",
    "\n",
    "    def find_table_in_body():\n",
    "        # available 頁面常見為 table#table\n",
    "        for css in [\n",
    "            \"div.dt-scroll-body table#table\",\n",
    "            \"div.dt-scroll-body table.table.dataTable_available\",\n",
    "            \"div.dt-scroll-body table.table.dataTable\",\n",
    "        ]:\n",
    "            try:\n",
    "                t = drv.find_element(By.CSS_SELECTOR, css)\n",
    "                if t: return t\n",
    "            except:\n",
    "                pass\n",
    "        return None\n",
    "\n",
    "    try:\n",
    "        drv.get(url)\n",
    "        close_banners()\n",
    "\n",
    "        # 等到滾動容器與首批列\n",
    "        body = wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"div.dt-scroll-body\")))\n",
    "        wait.until(EC.presence_of_element_located((By.CSS_SELECTOR, \"div.dt-scroll-body table tbody tr\")))\n",
    "        table = find_table_in_body()\n",
    "        if table is None:\n",
    "            table = wait.until(EC.presence_of_element_located((\n",
    "                By.CSS_SELECTOR, \"div.dt-scroll-body table\"\n",
    "            )))\n",
    "\n",
    "        # 讓所有列渲染完成：反覆捲到底直到 row 數與 scrollTop 穩定\n",
    "        last_scroll = -1\n",
    "        last_rows = -1\n",
    "        stable_hits = 0\n",
    "        for _ in range(600):  # 足夠容納 2025 的可用名單\n",
    "            drv.execute_script(\"arguments[0].scrollTop = arguments[0].scrollHeight;\", body)\n",
    "            time.sleep(0.12)\n",
    "            cur_scroll = drv.execute_script(\"return arguments[0].scrollTop;\", body)\n",
    "            cur_rows = len(table.find_elements(By.CSS_SELECTOR, \"tbody tr\"))\n",
    "            if cur_scroll == last_scroll and cur_rows == last_rows:\n",
    "                stable_hits += 1\n",
    "                if stable_hits >= 10:\n",
    "                    break\n",
    "            else:\n",
    "                stable_hits = 0\n",
    "                last_scroll, last_rows = cur_scroll, cur_rows\n",
    "\n",
    "        # 取表頭（最下層 thead tr 的 th）\n",
    "        ths = table.find_elements(By.CSS_SELECTOR, \"thead tr:last-child th\")\n",
    "        if not ths:\n",
    "            ths = table.find_elements(By.CSS_SELECTOR, \"thead th\")\n",
    "        headers = [\" \".join((th.get_attribute(\"innerText\") or th.text or \"\").split()) for th in ths]\n",
    "        if not headers:\n",
    "            raise RuntimeError(\"表頭未載入\")\n",
    "\n",
    "        # 找到 PLAYER 欄位索引以便抓超連結\n",
    "        player_idx = next((i for i,h in enumerate(headers) if h.strip().upper().startswith(\"PLAYER\")), None)\n",
    "\n",
    "        # 擷取所有資料列\n",
    "        rows_out = []\n",
    "        for tr in table.find_elements(By.CSS_SELECTOR, \"tbody tr\"):\n",
    "            tds = tr.find_elements(By.CSS_SELECTOR, \"td\")\n",
    "            if not tds: \n",
    "                continue\n",
    "            row = [\" \".join((td.get_attribute(\"innerText\") or td.text or \"\").split()) for td in tds]\n",
    "            # 補齊或截斷，與表頭同長\n",
    "            if len(row) < len(headers): \n",
    "                row += [\"\"]*(len(headers)-len(row))\n",
    "            if len(row) > len(headers): \n",
    "                row = row[:len(headers)]\n",
    "            # 取玩家超連結\n",
    "            player_url = \"\"\n",
    "            if player_idx is not None and player_idx < len(tds):\n",
    "                try:\n",
    "                    a = tds[player_idx].find_element(By.CSS_SELECTOR, \"a[href]\")\n",
    "                    player_url = a.get_attribute(\"href\") or \"\"\n",
    "                except:\n",
    "                    pass\n",
    "            row.append(player_url)\n",
    "            rows_out.append(row)\n",
    "\n",
    "        # 輸出 CSV\n",
    "        if out_dir is None:\n",
    "            out_dir = os.path.join(os.path.expanduser(\"~\"), \"Desktop\")\n",
    "        os.makedirs(out_dir, exist_ok=True)\n",
    "        out_csv = os.path.join(out_dir, f\"spotrac_free_agents_available_{year}.csv\")\n",
    "        with open(out_csv, \"w\", newline=\"\", encoding=\"utf-8\") as f:\n",
    "            w = csv.writer(f)\n",
    "            w.writerow(headers + [\"PlayerURL\"])\n",
    "            w.writerows(rows_out)\n",
    "\n",
    "        print(f\"OK year={year} rows={len(rows_out)} -> {out_csv}\")\n",
    "        return out_csv\n",
    "\n",
    "    finally:\n",
    "        try: drv.quit()\n",
    "        except: pass\n",
    "\n",
    "# 例：抓 2025 可用名單整表\n",
    "scrape_spotrac_available(2025)\n"
   ]
  }
 ],
 "metadata": {
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.13.3"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
